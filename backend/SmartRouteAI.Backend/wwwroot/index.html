<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SmartRouteAI - Yapay Zeka Destekli Rota Planlayıcı</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-route"></i> SmartRouteAI</h1>
            <p class="subtitle">Yapay Zeka Destekli Akıllı Rota Planlayıcı</p>
            <div class="features">
                <div class="feature-badge">
                    <i class="fas fa-brain"></i>
                    AI Destekli
                </div>
                <div class="feature-badge">
                    <i class="fas fa-cloud-sun"></i>
                    Hava Durumu
                </div>
                <div class="feature-badge">
                    <i class="fas fa-traffic-light"></i>
                    Trafik Analizi
                </div>
                <div class="feature-badge">
                    <i class="fas fa-calendar-alt"></i>
                    Tatil Bilgisi
                </div>
            </div>
        </div>

                <!-- AI Chat Section -->
        <div class="chat-section">
            <div class="chat-card">
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-robot"></i>
                        <h3>SmartRouteAI Asistanı</h3>
                        <span class="chat-status">Çevrimiçi</span>
    </div>
                    <div class="chat-actions">
                        <button id="clear-chat" class="btn-icon" title="Sohbeti Temizle">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="message bot-message">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                Merhaba! Ben SmartRouteAI asistanınız. Size en iyi rotayı bulmak için yardımcı olacağım. 
                                Nereye gitmek istiyorsunuz? Doğal dil ile isteğinizi yazabilirsiniz.
                            </div>
                            <div class="message-time">Şimdi</div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-area">
                    <div class="chat-input-container">
                        <textarea
                            id="prompt-input"
                            placeholder="Örnek: Ankaradan İstanbul'a en hızlı rota, yağmurlu hava koşullarında, ücretli yollardan kaçınarak..."
                            rows="1"
                        ></textarea>
                        <button id="prompt-btn" class="chat-send-btn" title="Gönder">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="chat-suggestions">
                        <span class="suggestion-label">Hızlı öneriler:</span>
                        <button class="suggestion-btn" data-suggestion="İstanbul'dan Ankara'ya en hızlı rota">🚗 En Hızlı</button>
                        <button class="suggestion-btn" data-suggestion="İzmir'den Antalya'ya en ekonomik rota">💰 En Ekonomik</button>
                        <button class="suggestion-btn" data-suggestion="Bursa'dan İstanbul'a yağmurlu havada rota">🌧️ Hava Durumu</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="map-section">
                <div id="map"></div>
                <div class="map-overlay">
                    <div class="map-control" onclick="resetMap()">
                        <i class="fas fa-undo"></i>
                        Sıfırla
                    </div>
                    <div class="map-control" onclick="toggleFullscreen()">
                        <i class="fas fa-expand"></i>
                        Tam Ekran
                    </div>
                </div>
            </div>
            <div id="route-options"></div>
        </div>

        <!-- Results Section -->
        <div id="result"></div>
        <div id="route-details"></div>
        
        <!-- Rota Ayarları - Alt Kısım -->
        <div class="sidebar" style="display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:2em auto;padding:1.5em 2em;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.1);flex-wrap:wrap;gap:1em;">
            <div class="input-group" style="display:flex;align-items:center;gap:0.5em;">
                <label for="from-place" style="margin:0;white-space:nowrap;">
                    <i class="fas fa-map-marker-alt"></i>
                    Başlangıç:
                </label>
                <select id="from-place" class="form-control" style="margin:0;">
                    <option value="">Haritadan seçin</option>
                    <option value="41.038946,28.813249">LCWAIKIKI GENEL MUDURLUK</option>
                    <option value="41.060634,28.659207">LCWAIKIKI LOJISTIK MERKEZ</option>
                    <option value="40.653129,29.354463">LCWAIKIKI YALOVA DEPO</option>
                </select>
                <span id="from-coord" class="coord-display" style="margin:0;">Seçilmedi</span>
            </div>

            <div class="input-group" style="display:flex;align-items:center;gap:0.5em;">
                <label for="to-place" style="margin:0;white-space:nowrap;">
                    <i class="fas fa-flag-checkered"></i>
                    Hedef:
                </label>
                <select id="to-place" class="form-control" style="margin:0;">
                    <option value="">Haritadan seçin</option>
                    <option value="41.038946,28.813249">LCWAIKIKI GENEL MUDURLUK</option>
                    <option value="41.060634,28.659207">LCWAIKIKI LOJISTIK MERKEZ</option>
                    <option value="40.653129,29.354463">LCWAIKIKI YALOVA DEPO</option>
                </select>
                <span id="to-coord" class="coord-display" style="margin:0;">Seçilmedi</span>
            </div>

            <div class="input-group" style="display:flex;align-items:center;gap:0.5em;">
                <label for="date-input" style="margin:0;white-space:nowrap;">
                    <i class="fas fa-calendar"></i>
                    Tarih:
                </label>
                <input type="date" id="date-input" class="form-control" style="margin:0;">
            </div>

            <div class="input-group" style="display:flex;align-items:center;gap:0.5em;">
                <label for="time-input" style="margin:0;white-space:nowrap;">
                    <i class="fas fa-clock"></i>
                    Saat:
                </label>
                <input type="time" id="time-input" class="form-control" style="margin:0;">
            </div>

            <button id="route-btn" class="btn-primary" style="margin:0;padding:0.7em 1.5em;">
                <i class="fas fa-search"></i>
                Rotayı Hesapla
            </button>

            <button id="reset-btn" class="btn-secondary" style="margin:0;padding:0.6em 1.2em;">
                <i class="fas fa-undo"></i>
                Sıfırla
            </button>
        </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Dakikayı "X Saat Y Dakika" formatına çeviren yardımcı fonksiyon
        function formatDuration(minutes) {
            if (!minutes || minutes <= 0) return '0 Dakika';
            
            // Ondalık kısmı temizle
            const cleanMinutes = Math.round(minutes);
            const hours = Math.floor(cleanMinutes / 60);
            const mins = cleanMinutes % 60;
            
            if (hours === 0) {
                return `${mins} Dakika`;
            } else if (mins === 0) {
                return `${hours} Saat`;
            } else {
                return `${hours} Saat ${mins} Dakika`;
            }
        }

        // Polyline decode (Google polyline formatı) - Optimize edilmiş versiyon
        function decodePolyline(encoded) {
            if (!encoded || encoded.length === 0) {
                console.warn('Empty polyline data');
                return [];
            }
            
            let points = [];
            let index = 0, len = encoded.length;
            let lat = 0, lng = 0;
            
            try {
                while (index < len) {
                    let b, shift = 0, result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lat += dlat;
                    shift = 0;
                    result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lng += dlng;
                    points.push([lat / 1e5, lng / 1e5]);
                }
                
                // Nokta sayısını optimize et - çok az nokta varsa interpolasyon yap
                if (points.length < 10 && points.length > 2) {
                    const optimizedPoints = [];
                    for (let i = 0; i < points.length - 1; i++) {
                        const start = points[i];
                        const end = points[i + 1];
                        optimizedPoints.push(start);
                        
                        // İki nokta arasına ara noktalar ekle
                        const distance = Math.sqrt(Math.pow(end[0] - start[0], 2) + Math.pow(end[1] - start[1], 2));
                        if (distance > 0.01) { // Sadece uzak noktalar arasına ara nokta ekle
                            const steps = Math.min(5, Math.floor(distance * 1000));
                            for (let j = 1; j < steps; j++) {
                                const ratio = j / steps;
                                const lat = start[0] + (end[0] - start[0]) * ratio;
                                const lng = start[1] + (end[1] - start[1]) * ratio;
                                optimizedPoints.push([lat, lng]);
                            }
                        }
                    }
                    optimizedPoints.push(points[points.length - 1]);
                    points = optimizedPoints;
                }
                
                console.log(`Decoded ${points.length} points from polyline (optimized)`);
                return points;
            } catch (error) {
                console.error('Error decoding polyline:', error);
                return [];
            }
        }
        const map = L.map('map').setView([41.0082, 28.9784], 10); // İstanbul merkezli
        // Google Maps tile layer Türkçe şehir isimleri ile - Optimize edilmiş ayarlar
        L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}&hl=tr', {
            maxZoom: 20,
            attribution: '© Google Maps',
            updateWhenZooming: false,
            updateWhenIdle: true,
            keepBuffer: 2,
            maxNativeZoom: 18,
            tileSize: 256,
            zoomOffset: 0
        }).addTo(map);

        let fromMarker = null;
        let toMarker = null;
        let fromCoord = null;
        let toCoord = null;
        let routeLine = null;
        let currentRoute = null;
        let allRoutes = [];
        let selectedRouteIndex = null;

        function updateCoords() {
            document.getElementById('from-coord').textContent = fromCoord ? `${fromCoord.lat.toFixed(5)}, ${fromCoord.lng.toFixed(5)}` : 'Seçilmedi';
            document.getElementById('to-coord').textContent = toCoord ? `${toCoord.lat.toFixed(5)}, ${toCoord.lng.toFixed(5)}` : 'Seçilmedi';
        }

        function showRouteOptions(routes) {
            const container = document.getElementById('route-options');
            
            if (!routes || routes.length === 0) {
                container.innerHTML = `
                    <div class="route-options-header">
                        <h3><i class="fas fa-route"></i> Alternatif Rotalar</h3>
                        <span class="route-count">0</span>
                    </div>
                    <div style="text-align:center;padding:40px;color:var(--text-secondary);">
                        <i class="fas fa-map-marked-alt" style="font-size:3rem;margin-bottom:20px;opacity:0.5;"></i>
                        <p>Henüz rota oluşturulmadı</p>
                        <small>AI asistanı ile konuşarak rota oluşturabilirsiniz</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="route-options-header">
                    <h3><i class="fas fa-route"></i> Alternatif Rotalar</h3>
                    <span class="route-count">${routes.length}</span>
                </div>
            `;
            
            routes.forEach((route, idx) => {
                console.log(`[FRONTEND] Route ${idx}:`, route);
                const div = document.createElement('div');
                div.className = 'route-card' + (selectedRouteIndex === idx ? ' selected' : '');
                div.onclick = function() { selectRoute(idx); };
                
                // Tatil ve AI bilgisi varsa göster
                let holidayBadge = '';
                let aiBadge = '';
                
                //#endregion
                if (route.isHoliday || route.holidayName) {
                    const holidayColor = route.isHoliday ? '#ff6b6b' : '#28a745';
                    holidayBadge = `<span style="background: ${holidayColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">
                        <i class="fas fa-calendar-alt"></i> ${route.holidayName || 'Tatil'}
                    </span>`;
                }
                //#region AI Optimizasyonu
                if (route.aiOptimized) {
                    const aiColor = route.aiOptimizationScore > 0.7 ? '#28a745' : route.aiOptimizationScore > 0.5 ? '#ffc107' : '#dc3545';
                    aiBadge = `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">
                        <i class="fas fa-robot"></i> AI ${(route.aiOptimizationScore * 100).toFixed(0)}%
                    </span>`;
                }
                
                // Süre bilgileri hazırlanıyor
                
                div.innerHTML = `
                    <div style="flex: 1;">
                        <div class="route-title" style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <span style="background: var(--primary-gradient); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600;">${idx + 1}</span>
                            <span>${route.title || `Rota ${idx + 1}`}</span>
                            ${holidayBadge}
                            ${aiBadge}
                            <div style="display: flex; align-items: center; gap: 4px; padding: 3px 6px; background: #f8fafc; border-radius: 3px;">
                                <i class="fas fa-road" style="color: #667eea; font-size: 0.6em;"></i>
                                <span class="route-title" style="font-size: 0.7em;"><strong>${route.distanceKm || 0} KM</strong></span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 3px; margin-bottom: 6px;">    
                            
                            <!-- Normal varış süresi -->
                            <div style="display: flex; align-items: center; gap: 4px; padding: 3px 6px; background: #e8f5e8; border-radius: 3px; border-left: 2px solid #28a745;">
                                <i class="fas fa-clock" style="color: #28a745; font-size: 0.6em;"></i>
                                <span class="route-info" style="font-size: 0.6em;"><strong>Normal:</strong> <strong>${formatDuration(route.durationMin || route.estimatedDurationMinutes)}</strong></span>
                            </div>
                            
                            <!-- Hava şartları nedeniyle varış süresi (eğer varsa) -->
                            ${route.durationType === "weather" || route.durationType === "combined" ? `
                            <div style="display: flex; align-items: center; gap: 4px; padding: 3px 6px; background: #fff3cd; border-radius: 3px; border-left: 2px solid #ffc107;">
                                <i class="fas fa-cloud-rain" style="color: #ffc107; font-size: 0.6em;"></i>
                                <span class="route-info" style="font-size: 0.6em;"><strong>Hava:</strong> ${formatDuration(route.weatherDurationMin || route.adjustedDurationMin)}</span>
                            </div>
                            ` : ''}
                            
                            <!-- Tatil günü nedeniyle varış süresi (eğer varsa) -->
                            ${route.durationType === "holiday" || route.durationType === "combined" ? `
                            <div style="display: flex; align-items: center; gap: 4px; padding: 3px 6px; background: #f8d7da; border-radius: 3px; border-left: 2px solid #dc3545;">
                                <i class="fas fa-calendar-alt" style="color: #dc3545; font-size: 0.6em;"></i>
                                <span class="route-info" style="font-size: 0.6em;"><strong>Tatil:</strong> ${formatDuration(route.holidayDurationMin || route.adjustedDurationMin)}</span>
                            </div>
                            ` : ''}
                            
                            <!-- Hava şartları ve tatil nedeniyle varış süresi (eğer varsa) -->
                            ${route.durationType === "combined" ? `
                            <div style="display: flex; align-items: center; gap: 4px; padding: 3px 6px; background: #d1ecf1; border-radius: 3px; border-left: 2px solid #17a2b8;">
                                <i class="fas fa-exclamation-triangle" style="color: #17a2b8; font-size: 0.6em;"></i>
                                <span class="route-info" style="font-size: 0.6em;"><strong>Hava+Tatil:</strong> ${formatDuration(route.combinedDurationMin || route.adjustedDurationMin)}</span>
                            </div>
                            ` : ''}
                            
                            <!-- TAHMİNİ VARİŞ - Kırmızı ve büyük -->
                            <div style="display: flex; align-items: center; gap: 4px; padding: 3px 6px; background: #dc3545; border-radius: 3px; margin-top: 3px;">
                                <i class="fas fa-flag-checkered" style="color: white; font-size: 0.5em;"></i>
                                <span class="route-info" style="color: white; font-size: 0.8em; font-weight: bold;">TAHMİNİ: ${formatDuration(route.adjustedDurationMin || route.estimatedDurationMinutes)}</span>
                            </div>
                        </div>
                        ${route.weatherImpact ? `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff3cd; border-radius: 8px; border-left: 3px solid #ffc107; margin-bottom: 8px;">
                                <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
                                <span style="font-size: 0.6em; color: #856404;">${route.weatherImpact}</span>
                            </div>
                        ` : ''}
                        <div style="margin-top: 8px; text-align: right;">
                            <button onclick="event.stopPropagation(); openGoogleMaps(${idx})" style="background:#4285f4;color:white;border:none;padding:0.5em 1em;border-radius:5px;cursor:pointer;font-size:0.9em;display:inline-flex;align-items:center;gap:0.3em;transition:all 0.3s ease;box-shadow:0 2px 4px rgba(66,133,244,0.3);" onmouseover="this.style.background='#3367d6';this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 8px rgba(66,133,244,0.4)'" onmouseout="this.style.background='#4285f4';this.style.transform='translateY(0)';this.style.boxShadow='0 2px 4px rgba(66,133,244,0.3)'">
                                <i class="fas fa-map-marked-alt"></i> Google Maps'te Aç
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <span class="route-toll" style="writing-mode: vertical-rl; text-orientation: mixed; padding: 8px 4px;">${route.tollClass || 'Ücretsiz'}</span>
                        <div style="width: 2px; height: 20px; background: var(--primary-gradient); border-radius: 1px;"></div>
                    </div>`;
                    

                container.appendChild(div);
            });
        }

        function showRouteDetails(route) {
            const details = document.getElementById('route-details');
            if (!route) { details.innerHTML = ''; return; }
            
            // Tatil bilgilerini göster
            let holidayInfo = '';
            if (route.isHoliday || route.holidayName) {
                const isHoliday = route.isHoliday || route.holidayName;
                const holidayColor = isHoliday ? '#ff6b6b' : '#28a745';
                const trafficMultiplier = route.holidayTrafficMultiplier || 1.0;
                const trafficColor = trafficMultiplier > 1.5 ? '#dc3545' : trafficMultiplier > 1.1 ? '#ffc107' : '#28a745';
                
                holidayInfo = `
                    <div style="grid-column: 1 / -1; background: ${isHoliday ? '#fff3cd' : '#d1ecf1'}; border-radius: 10px; padding: 15px; border-left: 3px solid ${holidayColor};">
                        <i class="fas fa-calendar-alt"></i> <b>Tarih Analizi:</b>
                        <br><b>Tatil:</b> <span style="color:${holidayColor};font-weight:bold;">${route.holidayName || 'Normal gün'}</span>
                        <br><b>Trafik Yoğunluğu:</b> <span style="color:${trafficColor};font-weight:bold;">${trafficMultiplier.toFixed(1)}x</span>
                        <br><b>Süre Etkisi:</b> <span style="color:${holidayColor};font-weight:bold;">${route.weatherImpact || 'Normal trafik'}</span>
                    </div>
                `;
            }
            
            // AI bilgilerini göster
            let aiInfo = '';
            if (route.aiOptimized) {
                const aiColor = route.aiOptimizationScore > 0.7 ? '#28a745' : route.aiOptimizationScore > 0.5 ? '#ffc107' : '#dc3545';
                aiInfo = `
                    <div style="grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; padding: 15px; color: white; margin-bottom: 10px;">
                        <i class="fas fa-robot"></i> <b>AI Optimizasyonu</b>
                        <br><b>Model:</b> ${route.aiModelUsed || 'LSTM + Transformer'}
                        <br><b>Optimizasyon Skoru:</b> <span style="color:${aiColor};font-weight:bold;">${(route.aiOptimizationScore * 100).toFixed(1)}%</span>
                        <br><b>Güven Skoru:</b> <span style="color:${aiColor};font-weight:bold;">${(route.aiConfidence * 100).toFixed(1)}%</span>
                    </div>
                `;
            }
            
            details.innerHTML = `
                <div class="route-details-card">
                    ${aiInfo}
                    ${holidayInfo}
                    <div><i class="fas fa-road"></i> <b>Mesafe:</b> ${route.distanceKm || 0} km</div>
                    <div><i class="fas fa-clock"></i> <b>Orijinal Süre:</b> ${formatDuration(route.durationMin || route.estimatedDurationMinutes)}</div>
                    <div><i class="fas fa-clock"></i> <b>${route.aiOptimized ? 'AI Optimize' : 'Düzeltilmiş'} Süre:</b> <span style="color:${route.adjustedDurationMin > (route.durationMin || route.estimatedDurationMinutes) ? '#dc3545' : '#28a745'};font-weight:bold;">${formatDuration(route.adjustedDurationMin || route.estimatedDurationMinutes)}</span></div>
                    <div><i class="fas fa-calendar-check"></i> <b>Tahmini varış:</b> ${route.arrivalStr || route.arrivalstr || '-'}</div>
                    <div><i class="fas fa-cloud-sun"></i> <b>Beklenen hava:</b> <span class="weather-main">${route.weatherDesc || route.weatherdesc ? (route.weatherDesc || route.weatherdesc).charAt(0).toUpperCase() + (route.weatherDesc || route.weatherdesc).slice(1) : (route.weather || '-')}</span></div>
                    <div><i class="fas fa-exclamation-triangle"></i> <b>${route.aiOptimized ? 'AI, Hava ve Tatil' : 'Hava ve Tatil'} Etkisi:</b> <span class="weather-impact">${route.weatherImpact || 'Yok'}</span></div>
                    <div><i class="fas fa-highway"></i> <b>Otoyol:</b> <span class="route-toll">${route.tollClass || 'Ücretsiz'}</span></div>
                    <div><i class="fas fa-credit-card"></i> <b>Ücretli geçiş:</b> <span class="route-toll">${route.tollInfo || route.tollinfo || '-'}</span></div>
                </div>
            `;
        }

        function selectRoute(idx) {
            selectedRouteIndex = idx;
            showRouteOptions(allRoutes);
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            const route = allRoutes[idx];
            
            // Polyline verisini farklı formatlardan al
            let polylineData = '';
            if (route.polyline) {
                polylineData = route.polyline;
            } else if (route.overviewPolyline && route.overviewPolyline.points) {
                polylineData = route.overviewPolyline.points;
            } else if (route.legs && route.legs.length > 0 && route.legs[0].overview_polyline && route.legs[0].overview_polyline.points) {
                polylineData = route.legs[0].overview_polyline.points;
            }
            
            if (polylineData && polylineData.length > 0) {
                const latlngs = decodePolyline(polylineData);
                if (latlngs.length > 1) {
                    routeLine = L.polyline(latlngs, {
                        color: '#6b5ac6', 
                        weight: 10, 
                        opacity: 0.9,
                        smoothFactor: 0.3,
                        lineCap: 'round',
                        lineJoin: 'round',
                        dashArray: null
                    }).addTo(map);
                    map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                    updateRouteStyle();
                } else {
                    console.warn('Route polyline decoded but insufficient points');
                }
            } else {
                console.warn('No polyline data found for route');
            }
            showRouteDetails(route);
        }

        // Dropdown seçimleri
        document.getElementById('from-place').onchange = function() {
            const val = this.value;
            if (val) {
                const [lat, lng] = val.split(',').map(Number);
                fromCoord = { lat, lng };
                if (fromMarker) { map.removeLayer(fromMarker); }
                fromMarker = L.marker([lat, lng], { draggable: true }).addTo(map).bindPopup('Başlangıç').openPopup();
                fromMarker.on('dragend', function(ev) {
                    fromCoord = ev.target.getLatLng();
                    document.getElementById('from-place').value = '';
                    updateCoords();
                });
                map.setView([lat, lng], 12);
                updateCoords();
            } else {
                if (fromMarker) { map.removeLayer(fromMarker); fromMarker = null; fromCoord = null; updateCoords(); }
            }
        };
        document.getElementById('to-place').onchange = function() {
            const val = this.value;
            if (val) {
                const [lat, lng] = val.split(',').map(Number);
                toCoord = { lat, lng };
                if (toMarker) { map.removeLayer(toMarker); }
                toMarker = L.marker([lat, lng], { draggable: true, icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32,32], iconAnchor: [16,32]}) }).addTo(map).bindPopup('Hedef').openPopup();
                toMarker.on('dragend', function(ev) {
                    toCoord = ev.target.getLatLng();
                    document.getElementById('to-place').value = '';
                    updateCoords();
                });
                map.setView([lat, lng], 12);
                updateCoords();
            } else {
                if (toMarker) { map.removeLayer(toMarker); toMarker = null; toCoord = null; updateCoords(); }
            }
        };

        // Haritadan tıklama kaldırıldı - sadece dropdown menülerden seçim yapılabilir

        document.getElementById('reset-btn').onclick = function() {
            if (fromMarker) { map.removeLayer(fromMarker); fromMarker = null; fromCoord = null; }
            if (toMarker) { map.removeLayer(toMarker); toMarker = null; toCoord = null; }
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            currentRoute = null;
            
            // Şehir etiketlerini temizle
            clearCityLabels();
            promptCities = [];
            
            updateCoords();
            document.getElementById('result').textContent = '';
            document.getElementById('route-details').innerHTML = ''; // Sıfırlama
        };

        function updateRouteStyle() {
            if (!routeLine) return;
            const zoom = map.getZoom();
            if (zoom < 12) {
                routeLine.setStyle({ 
                    color: '#6b5ac6', 
                    weight: 12, 
                    opacity: 0.9,
                    smoothFactor: 0.5,
                    lineCap: 'round',
                    lineJoin: 'round',
                    dashArray: null
                });
            } else if (zoom < 15) {
                routeLine.setStyle({ 
                    color: '#6b5ac6', 
                    weight: 10, 
                    opacity: 0.9,
                    smoothFactor: 0.3,
                    lineCap: 'round',
                    lineJoin: 'round',
                    dashArray: null
                });
            } else {
                routeLine.setStyle({ 
                    color: '#6b5ac6', 
                    weight: 8, 
                    opacity: 0.9,
                    smoothFactor: 0.1,
                    lineCap: 'round',
                    lineJoin: 'round',
                    dashArray: null
                });
            }
        }
        map.on('zoomend', updateRouteStyle);

        document.getElementById('route-btn').onclick = async function() {
            if (!fromCoord || !toCoord) {
                alert('Lütfen haritadan veya listeden başlangıç ve hedef seçin!');
                return;
            }
            const date = document.getElementById('date-input').value;
            const time = document.getElementById('time-input').value;
            if (!date || !time) {
                alert('Lütfen tarih ve saat seçin!');
                return;
            }
            const data = {
                fromLat: fromCoord.lat,
                fromLng: fromCoord.lng,
                toLat: toCoord.lat,
                toLng: toCoord.lng,
                date,
                time
            };
            console.log('[FRONTEND] Sending route request:', data);
            document.getElementById('result').textContent = 'Hesaplanıyor...';
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            currentRoute = null;
            try {
                const resp = await fetch('http://localhost:5077/route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await resp.json();
                if (result.error) {
                    document.getElementById('result').textContent = 'Hata: ' + result.error;
                } else if (result.routes && result.routes.length > 0) {
                    allRoutes = result.routes;
                    selectedRouteIndex = 0;
                    showRouteOptions(allRoutes);
                    document.getElementById('result').textContent = '';
                    selectRoute(0);
                } else {
                    document.getElementById('result').textContent = `Mesafe: ${result.distanceKm} km, Tahmini Süre: ${formatDuration(result.adjustedDurationMin || result.estimatedDurationMinutes)}`;
                    if (result.polyline) {
                        const latlngs = decodePolyline(result.polyline);
                        routeLine = L.polyline(latlngs, {
                            color: '#6b5ac6', 
                            weight: 10, 
                            opacity: 0.9,
                            smoothFactor: 0.3,
                            lineCap: 'round',
                            lineJoin: 'round',
                            dashArray: null
                        }).addTo(map);
                        routeLine.setZIndex(50); // Şehir isimlerinin arkasına geçmesi için çok düşük z-index
                        map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                        updateRouteStyle();
                    } else if (result.distanceKm > 0) {
                        alert('Yol bulundu ama rota çizilemedi. Mesafe: ' + result.distanceKm + ' km');
                    } else {
                        alert('Backendden rota verisi gelmedi veya boş. Lütfen farklı bir güzergah deneyin.');
                    }
                }
            } catch (err) {
                document.getElementById('result').textContent = 'Sunucuya ulaşılamıyor.';
            }
        };

        // Chat işleme
        const promptBtn = document.getElementById('prompt-btn');
        promptBtn.onclick = async function() {
            await sendMessage();
        };

        // Enter tuşu ile gönderme ve textarea boyutlandırma
        document.getElementById('prompt-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Textarea otomatik boyutlandırma
        document.getElementById('prompt-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Hızlı öneriler
        document.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const suggestion = this.getAttribute('data-suggestion');
                document.getElementById('prompt-input').value = suggestion;
                sendMessage();
            });
        });

        // Sohbeti temizle
        document.getElementById('clear-chat').addEventListener('click', function() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `
                <div class="message bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            Merhaba! Ben SmartRouteAI asistanınız. Size en iyi rotayı bulmak için yardımcı olacağım. 
                            Nereye gitmek istiyorsunuz? Doğal dil ile isteğinizi yazabilirsiniz.
                        </div>
                        <div class="message-time">Şimdi</div>
                    </div>
                </div>
            `;
        });

        async function sendMessage() {
            const promptInput = document.getElementById('prompt-input');
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            // Prompt'tan şehirleri çıkar
            promptCities = extractCitiesFromPrompt(prompt);
            console.log('Prompt\'tan çıkarılan şehirler:', promptCities);
            
            // Global prompt şehirlerini kaydet
            window._promptCities = promptCities;
            console.log('Saved prompt cities globally:', window._promptCities);
            
            // Önceki şehir etiketlerini temizle
            clearCityLabels();

            // Kullanıcı mesajını ekle
            addMessage(prompt, 'user');
            promptInput.value = '';

            // Gönder butonunu devre dışı bırak
            const sendBtn = document.getElementById('prompt-btn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // Bot yanıtını ekle (yükleniyor)
                const loadingId = addMessage('Rota analiz ediliyor ve hesaplanıyor...', 'bot', true);

                // Önce prompt analizi yap
                const analysisResponse = await fetch('/api/route/analyze-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                const analysis = await analysisResponse.json();
                
                // Sonra tam rota hesaplaması yap
                const routeResponse = await fetch('/api/route/plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                let routeData;
                try {
                    if (!routeResponse.ok) {
                        throw new Error(`HTTP ${routeResponse.status}: ${routeResponse.statusText}`);
                    }
                    const responseText = await routeResponse.text();
                    if (!responseText) {
                        throw new Error('Boş yanıt alındı');
                    }
                    routeData = JSON.parse(responseText);
                } catch (error) {
                    console.error('Rota hesaplama hatası:', error);
                    routeData = {
                        alternatives: [],
                        requests: [],
                        constraints: [],
                        weatherPredictions: [],
                        routeRecommendations: [],
                        costAnalysis: {},
                        routeSummary: {
                            totalCities: 0,
                            isHolidayPeriod: false,
                            holidayName: "",
                            avgTrafficMultiplier: 1.0,
                            totalDurationImpact: 1.0,
                            mlPredictionsCount: 0,
                            weatherConditions: []
                        },
                        mlServiceUsed: false,
                        trafficMultipliers: [],
                        holidayInfo: {}
                    };
                }
                
                // Yükleniyor mesajını kaldır
                removeMessage(loadingId);

                // Prompt şehirlerini haritada göster
                showPromptCitiesOnMap();

                // Detaylı bot yanıtını oluştur
                let responseText = `
                    <strong>🎯 Rota Analizi ve Hesaplama Tamamlandı!</strong><br><br>
                    <strong>📍 Kaynak:</strong> ${analysis.source || 'Belirlenemedi'}<br>
                    <strong>🎯 Hedef:</strong> ${analysis.destination || 'Belirlenemedi'}<br>
                    <strong>⚡ İstekler:</strong> ${(analysis.requests || []).join(', ') || 'Yok'}<br>
                    <strong>🌉 Köprü Direktifleri:</strong> ${(analysis.bridgeDirectives || []).map(d => d.name).join(', ') || 'Yok'}<br>
                    <strong>🛣️ Otoyol Direktifleri:</strong> ${(analysis.highwayDirectives || []).map(d => d.name).join(', ') || 'Yok'}<br>
                    <strong>🌤️ Hava Koşulları:</strong> ${(analysis.weatherConditions || []).join(', ') || 'Yok'}<br><br>
                `;

                // Tatil bilgilerini ekle
                if (routeData.holidayInfo && Object.keys(routeData.holidayInfo).length > 0) {
                    const holiday = routeData.holidayInfo;
                    const isHoliday = holiday.isHoliday || holiday.isWeekend;
                    const holidayColor = isHoliday ? '#ff6b6b' : '#28a745';
                    const holidayIcon = isHoliday ? '🎉' : '📅';
                    const trafficMultiplier = holiday.trafficMultiplier || 1.0;
                    
                    responseText += `
                        <div style="margin: 10px 0; padding: 10px; background: ${isHoliday ? '#fff3cd' : '#d1ecf1'}; border-radius: 8px; border-left: 4px solid ${holidayColor};">
                            <strong>${holidayIcon} Tarih Analizi:</strong><br>
                            <strong>Tarih:</strong> ${holiday.dayOfWeek || 'Bilinmiyor'}<br>
                            <strong>Tatil Durumu:</strong> <span style="color:${holidayColor};font-weight:bold;">${holiday.holidayName || 'Normal gün'}</span><br>
                            <strong>Trafik Yoğunluğu:</strong> <span style="color:${trafficMultiplier > 1.5 ? '#dc3545' : trafficMultiplier > 1.2 ? '#ffc107' : '#28a745'};font-weight:bold;">${trafficMultiplier.toFixed(1)}x</span>
                        </div>
                    `;
                }

                // Alternatif rotaları ekle
                if (routeData.alternatives && routeData.alternatives.length > 0) {
                    // Rotaları global değişkende sakla ve polyline formatını düzelt
                    window.chatRoutes = routeData.alternatives.map(route => {
                        // Polyline verisini farklı formatlardan al
                        let polylineData = '';
                        if (route.polyline) {
                            polylineData = route.polyline;
                        } else if (route.overviewPolyline && route.overviewPolyline.points) {
                            polylineData = route.overviewPolyline.points;
                        } else if (route.legs && route.legs.length > 0 && route.legs[0].overview_polyline && route.legs[0].overview_polyline.points) {
                            polylineData = route.legs[0].overview_polyline.points;
                        }
                        
                        return {
                            ...route,
                            polyline: polylineData
                        };
                    });
                    
                    // allRoutes'u da güncelle
                    allRoutes = window.chatRoutes;
                    
                    responseText += `<br><strong style="color:black;">🛣️ Alternatif Rotalar (${routeData.alternatives.length} adet):</strong><br>`;
                    
                    routeData.alternatives.forEach((alt, idx) => {
                        const durationDisplay = formatDuration(alt.adjustedDurationMin || alt.durationMin);
                        const tollInfo = alt.hasToll ? '<span style="color:#e74c3c;font-weight:bold;">💰 Ücretli yol</span>' : '<span style="color:#27ae60;">✅ Ücretsiz</span>';
                        const weatherImpact = alt.weatherImpact ? `<br><span style="color:#e74c3c;font-style:italic;font-size:0.6em;">🌤️ ${alt.weatherImpact}</span>` : '';
                        
                        responseText += `
                            <div style="margin: 8px 0; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #667eea; cursor: pointer;" onclick="selectRouteFromChat(${idx})">
                                <strong>Rota ${idx + 1}:</strong> ${alt.distanceKm} km, ${durationDisplay}<br>
                                ${tollInfo}${weatherImpact}
                            </div>
                        `;
                    });
                }

                // Debug: Hava durumu verilerini kontrol et
                console.log('Weather Predictions:', routeData.weatherPredictions);
                console.log('Weather Predictions length:', routeData.weatherPredictions?.length);
                
                // Hava durumu tahminlerini ekle
                if (routeData.weatherPredictions && routeData.weatherPredictions.length > 0) {
                    responseText += `<br><strong>🌤️ Rota Üzerindeki İllerin Hava Durumu:</strong><br>`;
                    
                    routeData.weatherPredictions.forEach(pred => {
                        console.log('Processing prediction:', pred);
                        const weatherIcon = pred.predictedWeather.toLowerCase().includes('kar') ? '❄️' : 
                                          pred.predictedWeather.toLowerCase().includes('yağmur') ? '🌧️' : '☀️';
                        
                        responseText += `${weatherIcon} <strong>${pred.city}:</strong> ${pred.predictedWeather} (${pred.avgTemperature}°C)<br>`;
                        responseText += `Güven: %${Math.round(pred.confidence * 100)}<br>`;
                    });
                } else {
                    console.log('No weather predictions found');
                    responseText += `<br><strong>🌤️ Rota Üzerindeki İllerin Hava Durumu:</strong><br>`;
                    responseText += `Hava durumu verisi bulunamadı<br>`;
                }

                responseText += `<br><em>💡 Yukarıdaki rotalardan birine tıklayarak haritada görüntüleyebilirsiniz!</em>`;
                
                addMessage(responseText, 'bot');

            } catch (error) {
                console.error('Rota hesaplama hatası:', error);
                if (typeof loadingId !== 'undefined') {
                    removeMessage(loadingId);
                }
                addMessage('❌ Rota hesaplama sırasında hata oluştu. Lütfen tekrar deneyin.', 'bot');
            } finally {
                // Gönder butonunu tekrar aktif et
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        function addMessage(text, sender, isLoading = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.id = messageId;
            
            const avatar = sender === 'bot' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${avatar}
                </div>
                <div class="message-content">
                    <div class="message-text">
                        ${isLoading ? '<i class="fas fa-spinner fa-spin"></i> ' : ''}${text}
                    </div>
                    <div class="message-time">${new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageId;
        }

        function removeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }

        // Chat'ten rota seçme fonksiyonu
        function selectRouteFromChat(routeIndex) {
            console.log(`[CHAT] selectRouteFromChat called with index: ${routeIndex}`);
            console.log(`[CHAT] window.chatRoutes:`, window.chatRoutes);
            
            // Global değişkenlerde rotaları saklayalım
            if (window.chatRoutes && window.chatRoutes[routeIndex]) {
                // allRoutes'u güncelle
                allRoutes = window.chatRoutes;
                selectedRouteIndex = routeIndex;
                
                console.log(`[CHAT] Selected route:`, window.chatRoutes[routeIndex]);
                console.log(`[CHAT] Route polyline:`, window.chatRoutes[routeIndex].polyline);
                
                // Orijinal selectRoute fonksiyonunu çağır
                selectRoute(routeIndex);
                
                // Bot mesajı ekle
                const route = window.chatRoutes[routeIndex];
                addMessage(`✅ Rota ${routeIndex + 1} haritada gösteriliyor! Mesafe: ${route.distanceKm} km, Süre: ${formatDuration(route.adjustedDurationMin || route.durationMin)}`, 'bot');
            } else {
                addMessage('❌ Rota bilgileri bulunamadı. Lütfen tekrar deneyin.', 'bot');
            }
        }

        // Eski prompt fonksiyonu (geçici olarak tutuyoruz)
        async function processPrompt() {
            const prompt = document.getElementById('prompt-input').value.trim();
            const resultDiv = document.getElementById('prompt-result');
            if (!prompt) {
                resultDiv.textContent = 'Lütfen bir prompt girin.';
                return;
            }
            resultDiv.textContent = 'Hesaplanıyor...';
            if (fromMarker) { map.removeLayer(fromMarker); fromMarker = null; }
            if (toMarker) { map.removeLayer(toMarker); toMarker = null; }
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            if (window._cityMarkers) window._cityMarkers.forEach(m => map.removeLayer(m));
            window._cityMarkers = [];
            try {
                const resp = await fetch('/api/route/plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                let data;
                try {
                    if (!resp.ok) {
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }
                    const responseText = await resp.text();
                    if (!responseText) {
                        throw new Error('Boş yanıt alındı');
                    }
                    data = JSON.parse(responseText);
                } catch (error) {
                    console.error('Rota hesaplama hatası:', error);
                    resultDiv.textContent = `Rota hesaplama hatası: ${error.message}`;
                    return;
                }
                if (!data.alternatives || data.alternatives.length === 0) {
                    resultDiv.textContent = 'Rota bulunamadı veya şehirler tespit edilemedi.';
                    return;
                }
                // Alternatif rotaları prompta göre sırala
                let sortedAlternatives = data.alternatives;
                const promptLower = prompt.toLowerCase();
                if (promptLower.includes('en uzun yol')) {
                    sortedAlternatives = [...data.alternatives].sort((a, b) => b.distanceKm - a.distanceKm);
                } else if (promptLower.includes('en kısa yol')) {
                    sortedAlternatives = [...data.alternatives].sort((a, b) => a.distanceKm - b.distanceKm);
                } else if (promptLower.includes('en maliyetli')) {
                    sortedAlternatives = [...data.alternatives].sort((a, b) => (b.hasToll ? 1 : 0) - (a.hasToll ? 1 : 0));
                } else if (promptLower.includes('en ucuz') || promptLower.includes('en düşük maliyet')) {
                    sortedAlternatives = [...data.alternatives].sort((a, b) => (a.hasToll ? 1 : 0) - (b.hasToll ? 1 : 0));
                }
                // Alternatif rotaları kartlar halinde göster
                let altHtml = '<b style="color:black;">Alternatif Rotalar:</b><br><div id="alt-routes-list" style="display:flex;flex-direction:column;gap:1em;margin-top:1em;">';
                sortedAlternatives.forEach((alt, idx) => {
                    altHtml += `<div class="route-card" id="route-card-${idx}" style="padding:1em;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);background:#fff;cursor:pointer;${idx===0?'border:2px solid #2a3d66;':''}" onclick="window.selectAltRoute(${idx})">
                        <b>${alt.summary || 'Alternatif Rota ' + (idx+1)}</b><br>
                        Mesafe: ${alt.distanceKm} km, Süre: ${formatDuration(alt.adjustedDurationMin || alt.durationMin)}<br>
                        ${alt.hasToll ? '<span style=\"color:#e74c3c;font-weight:bold;\">Ücretli yol içerir</span>' : '<span style=\"color:#27ae60;\">Ücretli yol içermez</span>'}
                        ${alt.weatherImpact ? `<br><span style=\"color:#e74c3c;font-weight:bold;font-style:italic;font-size:0.6em;\">${alt.weatherImpact}</span>` : ''}

                    </div>`;
                });
                altHtml += '</div>';
                
                // Tatil bilgilerini göster
                let holidayHtml = '';
                if (data.holidayInfo && Object.keys(data.holidayInfo).length > 0) {
                    const holiday = data.holidayInfo;
                    const isHoliday = holiday.isHoliday || holiday.isWeekend;
                    const holidayColor = isHoliday ? '#ff6b6b' : '#28a745';
                    const holidayIcon = isHoliday ? '🎉' : '📅';
                    const trafficMultiplier = holiday.trafficMultiplier || 1.0;
                    const trafficColor = trafficMultiplier > 1.5 ? '#dc3545' : trafficMultiplier > 1.1 ? '#ffc107' : '#28a745';
                    
                    holidayHtml = `<br><div style="margin-top:1em;padding:1em;background:${isHoliday ? '#fff3cd' : '#d1ecf1'};border-radius:8px;border-left:4px solid ${holidayColor};">
                        <b>${holidayIcon} Tarih Analizi:</b><br>
                        <div style="margin:0.5em 0;padding:1em;background:white;border-radius:6px;">
                            <b>Tarih:</b> ${holiday.dayOfWeek || 'Bilinmiyor'}
                            <br><b>Tatil Durumu:</b> <span style="color:${holidayColor};font-weight:bold;">${holiday.holidayName || 'Normal gün'}</span>
                            ${holiday.holidayType ? `<br><b>Tatil Türü:</b> <span style="color:#6c757d;">${holiday.holidayType}</span>` : ''}
                            <br><b>Trafik Yoğunluğu:</b> <span style="color:${trafficColor};font-weight:bold;">${trafficMultiplier.toFixed(1)}x</span>
                            <br><b>Etki:</b> <span style="color:${holidayColor};font-weight:bold;">${holiday.holidayImpact || 'Normal trafik'}</span>
                            ${holiday.isWeekend ? '<br><span style="color:#ffc107;font-weight:bold;">⚠️ Hafta sonu - Trafik yoğunluğu artabilir</span>' : ''}
                        </div>
                    </div>`;
                }
                
                // Gelişmiş hava durumu tahminlerini göster
                let weatherHtml = '';
                if (data.weatherPredictions && data.weatherPredictions.length > 0) {
                    weatherHtml = '<br><div style="margin-top:1em;padding:1em;background:#f8f9fa;border-radius:8px;border-left:4px solid #007bff;"><b>🌤️ Rota Üzerindeki İllerin Detaylı Analizi:</b><br>';
                    data.weatherPredictions.forEach(pred => {
                        const weatherIcon = pred.predictedWeather.toLowerCase().includes('kar') ? '❄️' : 
                                          pred.predictedWeather.toLowerCase().includes('yağmur') ? '🌧️' : '☀️';
                        const confidenceColor = pred.confidence > 0.8 ? '#28a745' : pred.confidence > 0.6 ? '#ffc107' : '#dc3545';
                        const trafficColor = pred.trafficMultiplier > 1.5 ? '#dc3545' : pred.trafficMultiplier < 0.7 ? '#28a745' : '#ffc107';
                        const holidayBadge = pred.isHoliday ? `<span style="background:#ff6b6b;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;">${pred.holidayName}</span>` : '';
                        
                        weatherHtml += `<div style="margin:0.5em 0;padding:1em;background:white;border-radius:6px;border-left:3px solid ${confidenceColor};">
                            ${weatherIcon} <b>${pred.city}</b> ${holidayBadge}
                            <br><span style="color:#666;font-size:0.9em;">${pred.season} mevsimi • ${pred.climateZone} iklimi • ${pred.avgTemperature}°C</span>
                            <br><b>Beklenen Hava:</b> ${pred.predictedWeather}
                            <br><b>Trafik Yoğunluğu:</b> <span style="color:${trafficColor};font-weight:bold;">${pred.trafficMultiplier.toFixed(1)}x</span>
                            <br><b>Süre Etkisi:</b> <span style="color:${pred.weatherDurationImpact > 1.2 ? '#dc3545' : '#28a745'};font-weight:bold;">${pred.weatherDurationImpact.toFixed(1)}x</span>
                            <br><small style="color:#666;">${pred.explanation}</small>
                            <br><small style="color:#666;">${pred.trafficExplanation}</small>
                            <br><small style="color:${confidenceColor};font-weight:bold;">Güven: %${Math.round(pred.confidence * 100)}</small>
                        </div>`;
                    });
                    weatherHtml += '</div>';
                }
                
                // Rota önerilerini göster
                let recommendationsHtml = '';
                if (data.routeRecommendations && data.routeRecommendations.length > 0) {
                    recommendationsHtml = '<br><div style="margin-top:1em;padding:1em;background:#fff3cd;border-radius:8px;border-left:4px solid #ffc107;"><b>💡 Akıllı Rota Önerileri:</b><br>';
                    data.routeRecommendations.forEach(rec => {
                        const priorityColor = rec.priority === 'high' ? '#dc3545' : rec.priority === 'medium' ? '#ffc107' : '#28a745';
                        const impactIcon = rec.impact === 'duration_increase' ? '⏰' : 
                                         rec.impact === 'safety_improvement' ? '🛡️' : 
                                         rec.impact === 'traffic_avoidance' ? '🚗' : '💡';
                        
                        recommendationsHtml += `<div style="margin:0.5em 0;padding:0.8em;background:white;border-radius:6px;border-left:3px solid ${priorityColor};">
                            ${impactIcon} <b>${rec.message}</b>
                            <br><small style="color:${priorityColor};font-weight:bold;">Öncelik: ${rec.priority.toUpperCase()}</small>
                        </div>`;
                    });
                    recommendationsHtml += '</div>';
                }
                
                // Maliyet analizini göster
                let costHtml = '';
                if (data.costAnalysis && Object.keys(data.costAnalysis).length > 0) {
                    costHtml = '<br><div style="margin-top:1em;padding:1em;background:#d1ecf1;border-radius:8px;border-left:4px solid #17a2b8;"><b>💰 Rota Maliyet Analizi:</b><br>';
                    if (data.costAnalysis.total_cost) {
                        costHtml += `<div style="margin:0.5em 0;padding:0.8em;background:white;border-radius:6px;">
                            <b>Toplam Maliyet:</b> <span style="color:#dc3545;font-weight:bold;font-size:1.2em;">${data.costAnalysis.total_cost} TL</span>
                            <br><small style="color:#666;">Yaklaşık ${data.costAnalysis.cost_per_km?.toFixed(2) || '0'} TL/km</small>
                        </div>`;
                    }
                    if (data.costAnalysis.toll_details && data.costAnalysis.toll_details.length > 0) {
                        costHtml += '<div style="margin:0.5em 0;padding:0.8em;background:white;border-radius:6px;"><b>Ücretli Geçişler:</b><br>';
                        data.costAnalysis.toll_details.forEach(toll => {
                            costHtml += `<small>• ${toll.name}: ${toll.cost} TL (${toll.type})</small><br>`;
                        });
                        costHtml += '</div>';
                    }
                    costHtml += '</div>';
                }
                
                // Rota özetini göster
                let summaryHtml = '';
                if (data.routeSummary) {
                    const summary = data.routeSummary;
                    const holidayBadge = summary.isHolidayPeriod ? `<span style="background:#ff6b6b;color:white;padding:4px 8px;border-radius:4px;font-size:0.9em;">${summary.holidayName}</span>` : '';
                    
                    summaryHtml = '<br><div style="margin-top:1em;padding:1em;background:#e2e3e5;border-radius:8px;border-left:4px solid #6c757d;"><b>📊 Rota Özeti:</b><br>';
                    summaryHtml += `<div style="margin:0.5em 0;padding:0.8em;background:white;border-radius:6px;">
                        <b>Toplam Şehir:</b> ${summary.totalCities} il
                        ${holidayBadge}
                        <br><b>Ortalama Trafik Yoğunluğu:</b> <span style="color:${summary.avgTrafficMultiplier > 1.5 ? '#dc3545' : summary.avgTrafficMultiplier < 0.7 ? '#28a745' : '#ffc107'};font-weight:bold;">${summary.avgTrafficMultiplier.toFixed(1)}x</span>
                        <br><b>Toplam Süre Etkisi:</b> <span style="color:${summary.totalDurationImpact > 1.2 ? '#dc3545' : '#28a745'};font-weight:bold;">${summary.totalDurationImpact.toFixed(1)}x</span>
                    </div>`;
                    summaryHtml += '</div>';
                }
                
                resultDiv.innerHTML = altHtml + holidayHtml + weatherHtml + recommendationsHtml + costHtml + summaryHtml + `<br><b>İstekler:</b> ${data.requests ? data.requests.join(', ') : '-'}` + (data.constraints && data.constraints.length > 0 ? `<br><b>Kısıtlamalar:</b> ${data.constraints.join(', ')}` : '');

                // Tatil bilgilerini global değişkene kaydet
                window._currentHolidayInfo = data.holidayInfo;

                // Varsayılan olarak ilk rotayı çiz
                window._promptAlternatives = sortedAlternatives;
                window.selectAltRoute = function(idx) {
                    if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
                    if (window._cityMarkers) window._cityMarkers.forEach(m => map.removeLayer(m));
                    window._cityMarkers = [];
                    const alt = window._promptAlternatives[idx];
                    // Şehir markerları
                    let bounds = [];
                    for (let i = 0; i < alt.route.length; i++) {
                        let city = alt.route[i];
                        let parts = city.split(/,|\/|-/).map(s => s.trim());
                        // Şehir eşleştirme için normalize edilmiş map
                        const turkishMap = { 'İ':'I', 'ı':'i', 'Ş':'S', 'ş':'s', 'Ğ':'G', 'ğ':'g', 'Ü':'U', 'ü':'u', 'Ö':'O', 'ö':'o', 'Ç':'C', 'ç':'c' };
                        function normalize(str) { return str.replace(/[İıŞşĞğÜüÖöÇç]/g, c => turkishMap[c] || c).toLowerCase(); }
                        let foundCity = null;
                        // Önce tüm parçalarda ara (normalize map ile)
                        outer: for (const part of parts) {
                            const norm = normalize(part);
                            if (cityCentersMap[norm]) { foundCity = cityCentersMap[norm]; break outer; }
                        }
                        // Hiçbiri bulunamazsa, son parçayı şehir olarak dene
                        if (!foundCity && parts.length > 1) {
                            const lastPart = parts[parts.length-1];
                            const norm = normalize(lastPart);
                            if (cityCentersMap[norm]) { foundCity = cityCentersMap[norm]; }
                        }
                        if (foundCity) {
                            const cityCoords = cityCenters[foundCity];
                            const marker = L.marker(cityCoords, { icon: i === 0 ? startIcon : (i === alt.route.length-1 ? endIcon : waypointIcon) }).addTo(map).bindPopup(foundCity);
                            bounds.push(cityCoords);
                            window._cityMarkers.push(marker);
                // Şehir label'ı eklenmiyor - sadece marker kalsın
                        }
                    }
                    if (bounds.length > 0) map.fitBounds(bounds, {padding: [50, 50]});
                    // Polyline ile rota çiz
                    if (alt.polyline && alt.polyline.length > 0) {
                        const latlngs = decodePolyline(alt.polyline);
                        if (latlngs.length > 1) {
                            routeLine = L.polyline(latlngs, {
                                color: '#6b5ac6', 
                                weight: 10, 
                                opacity: 0.9,
                                smoothFactor: 0.3,
                                lineCap: 'round',
                                lineJoin: 'round',
                                dashArray: null
                            }).addTo(map);
                            routeLine.setZIndex(50); // Şehir isimlerinin arkasına geçmesi için çok düşük z-index
                            map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                            updateRouteStyle();
                        } else {
                            console.warn('Polyline decoded but insufficient points');
                            if (bounds.length > 1) {
                                                        routeLine = L.polyline(bounds, {
                            color: '#6b5ac6', 
                            weight: 10, 
                            opacity: 0.9,
                            smoothFactor: 0.3,
                            lineCap: 'round',
                            lineJoin: 'round',
                            dashArray: null
                        }).addTo(map);
                        routeLine.setZIndex(50); // Şehir isimlerinin arkasına geçmesi için çok düşük z-index
                            }
                        }
                    } else if (bounds.length > 1) {
                        console.log('Using bounds for route line');
                        routeLine = L.polyline(bounds, {
                            color: '#6b5ac6', 
                            weight: 10, 
                            opacity: 0.9,
                            smoothFactor: 0.3,
                            lineCap: 'round',
                            lineJoin: 'round',
                            dashArray: null
                        }).addTo(map);
                        routeLine.setZIndex(50); // Şehir isimlerinin arkasına geçmesi için çok düşük z-index
                    } else {
                        console.warn('No polyline or bounds available for route');
                    }
                };
                window.selectAltRoute(0);
            } catch (err) {
                resultDiv.textContent = 'Sunucuya ulaşılamadı veya hata oluştu.';
            }
        };
        // Şehir merkezleri koordinatları (örnek, Türkiye'nin büyük şehirleri)
        const cityCenters = {
            "Adana": [37.0, 35.3213], "Adıyaman": [37.7648, 38.2786], "Afyonkarahisar": [38.7638, 30.5403], "Ağrı": [39.7191, 43.0503], "Amasya": [40.6539, 35.8336], "Ankara": [39.9334, 32.8597], "Antalya": [36.8969, 30.7133], "Artvin": [41.1828, 41.8183], "Aydın": [37.8450, 27.8396], "Balıkesir": [39.6484, 27.8826], "Bilecik": [40.1428, 29.9793], "Bingöl": [39.0626, 40.7696], "Bitlis": [38.4011, 42.1078], "Bolu": [40.5760, 31.5788], "Burdur": [37.7203, 30.2908], "Bursa": [40.1826, 29.0665], "Çanakkale": [40.1553, 26.4142], "Çankırı": [40.6013, 33.6134], "Çorum": [40.5506, 34.9556], "Denizli": [37.7765, 29.0864], "Diyarbakır": [37.9144, 40.2306], "Edirne": [41.6771, 26.5557], "Elazığ": [38.6743, 39.2232], "Erzincan": [39.7500, 39.5000], "Erzurum": [39.9043, 41.2679], "Eskişehir": [39.7767, 30.5206], "Gaziantep": [37.0662, 37.3833], "Giresun": [40.9128, 38.3895], "Gümüşhane": [40.4603, 39.4814], "Hakkari": [37.5744, 43.7408], "Hatay": [36.2021, 36.1600], "Isparta": [37.7648, 30.5566], "Mersin": [36.8121, 34.6415], "İstanbul": [41.0082, 28.9784], "İzmir": [38.4192, 27.1287], "Kars": [40.6013, 43.0975], "Kastamonu": [41.3897, 33.7827], "Kayseri": [38.7312, 35.4787], "Kırklareli": [41.7351, 27.2250], "Kırşehir": [39.1458, 34.1606], "Kocaeli": [40.8533, 29.8815], "Konya": [37.8746, 32.4932], "Kütahya": [39.4242, 29.9833], "Malatya": [38.3552, 38.3095], "Manisa": [38.6191, 27.4289], "Kahramanmaraş": [37.5736, 36.9371], "Mardin": [37.3212, 40.7245], "Muğla": [37.2153, 28.3636], "Muş": [38.9462, 41.7539], "Nevşehir": [38.6244, 34.7236], "Niğde": [37.9667, 34.6833], "Ordu": [40.9847, 37.8789], "Rize": [41.0256, 40.5177], "Sakarya": [40.7569, 30.3781], "Samsun": [41.2867, 36.33], "Siirt": [37.9274, 41.9456], "Sinop": [42.0267, 35.1551], "Sivas": [39.7477, 37.0179], "Tekirdağ": [40.9780, 27.5110], "Tokat": [40.3167, 36.5544], "Trabzon": [41.0015, 39.7178], "Tunceli": [39.1081, 39.5483], "Şanlıurfa": [37.1674, 38.7955], "Uşak": [38.6823, 29.4082], "Van": [38.5019, 43.4167], "Yozgat": [39.8181, 34.8147], "Zonguldak": [41.4564, 31.7987], "Aksaray": [38.3687, 34.0360], "Bayburt": [40.2567, 40.2249], "Karaman": [37.1759, 33.2287], "Kırıkkale": [39.8468, 33.5153], "Batman": [37.8812, 41.1351], "Şırnak": [37.4187, 42.4918], "Bartın": [41.6358, 32.3375], "Ardahan": [41.1105, 42.7022], "Iğdır": [39.9237, 44.0450], "Yalova": [40.6500, 29.2667], "Karabük": [41.2061, 32.6204], "Kilis": [36.7184, 37.1212], "Osmaniye": [37.0742, 36.2478], "Düzce": [40.8438, 31.1565]
        };
        // Şehir eşleştirme için normalize edilmiş map
        const turkishMap = { 'İ':'I', 'ı':'i', 'Ş':'S', 'ş':'s', 'Ğ':'G', 'ğ':'g', 'Ü':'U', 'ü':'u', 'Ö':'O', 'ö':'o', 'Ç':'C', 'ç':'c' };
        function normalize(str) { return str.replace(/[İıŞşĞğÜüÖöÇç]/g, c => turkishMap[c] || c).toLowerCase(); }
        const cityCentersMap = {};
        for (const key in cityCenters) { cityCentersMap[normalize(key)] = key; }

        // Prompt ile tespit edilen şehirler için marker ve label ekle
        function showPromptCitiesOnMap() {
            clearCityLabels();
            if (!window.promptCities || !Array.isArray(window.promptCities)) return;
            window.promptCities.forEach((city, idx) => {
                const cityNameNorm = normalize(city);
                const cityKey = cityCentersMap[cityNameNorm];
                if (!cityKey) return;
                const coords = cityCenters[cityKey];
                if (!coords) return;
                // Marker ekle
                const marker = L.marker([coords.lat, coords.lng], { icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32,32], iconAnchor: [16,32]}) }).addTo(map);
                addCityLabel(marker, cityKey, idx === 0 ? 'start' : (idx === window.promptCities.length-1 ? 'end' : 'waypoint'));
            });
            updateAllCityLabels();
        }
        // Özel şehir marker ikonları
        const startIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', 
            iconSize: [40, 40], 
            iconAnchor: [20, 40],
            className: 'city-marker start'
        });
        const endIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/149/149059.png', 
            iconSize: [40, 40], 
            iconAnchor: [20, 40],
            className: 'city-marker end'
        });
        const waypointIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png', 
            iconSize: [36, 36], 
            iconAnchor: [18, 36],
            className: 'city-marker waypoint'
        });
        const otherIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png', 
            iconSize: [32, 32], 
            iconAnchor: [16, 32],
            className: 'city-marker other'
        });

        // Prompt'tan çıkarılan şehirleri takip etmek için global değişken
        let promptCities = [];
        let cityLabels = [];

        // Şehir etiketlerini temizle
        function clearCityLabels() {
            // Şehir etiketlerini temizle
            cityLabels.forEach(label => {
                if (label && map.hasLayer(label)) {
                    map.removeLayer(label);
                }
            });
            cityLabels = [];
            
            // Eski şehir marker'larını da temizle
            if (window._cityMarkers && Array.isArray(window._cityMarkers)) {
                window._cityMarkers.forEach(marker => {
                    if (marker && map.hasLayer(marker)) {
                        map.removeLayer(marker);
                    }
                });
                window._cityMarkers = [];
            }
            
            // Eski rota çizgilerini temizle
            if (routeLine && map.hasLayer(routeLine)) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
        }

        // Şehir etiketlerini ekle
        function addCityLabel(cityName, coords, type) {
            // Marker ikonunu ve label'ı birlikte ekle
            // Şehir markerı (pin)
            let markerIcon;
            if (type === 'start') markerIcon = startIcon;
            else if (type === 'end') markerIcon = endIcon;
            else if (type === 'waypoint') markerIcon = waypointIcon;
            else markerIcon = otherIcon;

            // Marker'ı ekle
            const marker = L.marker(coords, { icon: markerIcon }).addTo(map);
            
            // Label için divIcon ekle (marker'ın tam altında ve Google Maps şehir isimleriyle hizalı)
            const labelIcon = L.divIcon({
                className: `city-label ${type}`,
                html: `<div class="city-name-label ${type}-label">${cityName}</div>`,
                iconSize: [150, 30],
                iconAnchor: [75, -10] // marker'ın altında, ortalanmış ve Google Maps ile hizalı
            });
            const labelMarker = L.marker(coords, { icon: labelIcon, interactive: false }).addTo(map);
            cityLabels.push(marker);
            cityLabels.push(labelMarker);
            return marker;
        }

        // Prompt şehirlerini haritada göster
        function showPromptCitiesOnMap() {
            if (!promptCities || promptCities.length === 0) return;
            
            // _cityMarkers dizisini başlat
            if (!window._cityMarkers) {
                window._cityMarkers = [];
            }
            
            promptCities.forEach((cityName, index) => {
                const cityData = cityCenters[cityName];
                if (cityData) {
                    const [lat, lng] = cityData;
                    let type = 'other';
                    let icon = otherIcon;
                    
                    // İlk şehir başlangıç, son şehir hedef, diğerleri ara durak
                    if (index === 0) {
                        type = 'start';
                        icon = startIcon;
                    } else if (index === promptCities.length - 1) {
                        type = 'end';
                        icon = endIcon;
                    } else {
                        type = 'waypoint';
                        icon = waypointIcon;
                    }
                    
                    // Şehir marker'ını ekle
                    const marker = L.marker([lat, lng], { icon: icon }).addTo(map);
                    marker.bindPopup(`<b>${cityName}</b><br>${type === 'start' ? '🚀 Başlangıç' : type === 'end' ? '🎯 Hedef' : '📍 Ara Durak'}`);
                    window._cityMarkers.push(marker);
                    
                    // Şehir etiketini ekle (kapatıldı - sadece marker kalsın)
                    // addCityLabelV2(cityName, [lat, lng], type);
                }
            });
        }

        // Şehir etiketlerini ekle (Google Maps hizalaması için optimize edilmiş)
        function addCityLabelV2(cityName, coords, type) {
            // Türkçe karakterleri düzgün göstermek için UTF-8 encoding
            const encodedCityName = cityName.replace(/ı/g, 'ı').replace(/İ/g, 'İ').replace(/ş/g, 'ş').replace(/Ş/g, 'Ş').replace(/ğ/g, 'ğ').replace(/Ğ/g, 'Ğ').replace(/ü/g, 'ü').replace(/Ü/g, 'Ü').replace(/ö/g, 'ö').replace(/Ö/g, 'Ö').replace(/ç/g, 'ç').replace(/Ç/g, 'Ç');
            
            const label = L.divIcon({
                className: `city-label ${type}`,
                html: `<div class="city-name-label ${type}-label">${encodedCityName}</div>`,
                iconSize: [200, 25],
                iconAnchor: [100, -15] // Google Maps şehir isimleriyle tam hizalı: merkez ve koordinatın altında
            });
            
            const marker = L.marker(coords, { icon: label }).addTo(map);
            cityLabels.push(marker);
            return marker;
        }



        // Prompt'tan şehirleri çıkar
        function extractCitiesFromPrompt(prompt) {
            const cities = [];
            const promptLower = prompt.toLowerCase();
            
            // Şehirleri prompt'taki sıraya göre bul
            for (const cityName in cityCenters) {
                const cityNameLower = cityName.toLowerCase();
                const position = promptLower.indexOf(cityNameLower);
                if (position >= 0) {
                    cities.push({ name: cityName, position: position });
                }
            }
            
            // Şehirleri prompt'taki pozisyonlarına göre sırala
            cities.sort((a, b) => a.position - b.position);
            
            // Sadece şehir isimlerini döndür
            return cities.map(city => city.name);
        }

        // Enter tuşu ile prompt rota oluştur
        const promptInput = document.getElementById('prompt-input');
        if (promptInput) {
        promptInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('prompt-btn').click();
            }
        });
        }

        // Yeni harita kontrol fonksiyonları
        function resetMap() {
            if (fromMarker) { map.removeLayer(fromMarker); fromMarker = null; fromCoord = null; }
            if (toMarker) { map.removeLayer(toMarker); toMarker = null; toCoord = null; }
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            clearCityLabels();
            updateCoords();
            document.getElementById('result').textContent = '';
            document.getElementById('route-details').innerHTML = '';
            showRouteOptions([]);
            
            // Haritayı İstanbul'a geri döndür
            map.setView([41.0082, 28.9784], 10);
        }

        function toggleFullscreen() {
            const mapContainer = document.getElementById('map');
            if (!document.fullscreenElement) {
                mapContainer.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Google Maps'te rota açma fonksiyonu
        function openGoogleMaps(idx) {
            const route = allRoutes[idx];
            console.log('Opening Google Maps for route:', route);
            
            if (!route) {
                console.error('Route not found');
                return;
            }
            
            // 1. Google Maps sıralı rota (en güvenilir yöntem - öncelik)
            if (window._promptCities && window._promptCities.length >= 2) {
                console.log('Using prompt cities for Google Maps:', window._promptCities);
                
                // Tüm şehirleri sırayla ziyaret etmek için
                if (window._promptCities.length === 2) {
                    // Sadece 2 şehir varsa
                    const googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(window._promptCities[0])}/${encodeURIComponent(window._promptCities[1])}`;
                    console.log('Opening Google Maps with 2 cities:', googleMapsUrl);
                    window.open(googleMapsUrl, '_blank');
                    return;
                } else if (window._promptCities.length === 3) {
                    // 3 şehir varsa: A -> B -> C (sırayla)
                    const googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(window._promptCities[0])}/${encodeURIComponent(window._promptCities[1])}/${encodeURIComponent(window._promptCities[2])}`;
                    console.log('Opening Google Maps with 3 cities in order:', googleMapsUrl);
                    window.open(googleMapsUrl, '_blank');
                    return;
                } else if (window._promptCities.length === 4) {
                    // 4 şehir varsa: A -> B -> C -> D (sırayla)
                    const googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(window._promptCities[0])}/${encodeURIComponent(window._promptCities[1])}/${encodeURIComponent(window._promptCities[2])}/${encodeURIComponent(window._promptCities[3])}`;
                    console.log('Opening Google Maps with 4 cities in order:', googleMapsUrl);
                    window.open(googleMapsUrl, '_blank');
                    return;
                } else {
                    // 4'ten fazla şehir varsa sırayla ekle
                    const citiesStr = window._promptCities.map(city => encodeURIComponent(city)).join('/');
                    const googleMapsUrl = `https://www.google.com/maps/dir/${citiesStr}`;
                    console.log('Opening Google Maps with multiple cities in order:', googleMapsUrl);
                    window.open(googleMapsUrl, '_blank');
                    return;
                }
            }
            
            // 2. Polyline'dan detaylı rota oluştur (alternatif yöntem)
            if (route.polyline && route.polyline.length > 0) {
                try {
                    const coordinates = decodePolyline(route.polyline);
                    console.log('Decoded polyline coordinates:', coordinates.length, 'points');
                    
                    if (coordinates.length >= 2) {
                        // Koordinatları kontrol et
                        const validCoordinates = coordinates.filter(point => 
                            point && typeof point.lat === 'number' && typeof point.lng === 'number' &&
                            !isNaN(point.lat) && !isNaN(point.lng) &&
                            point.lat >= -90 && point.lat <= 90 &&
                            point.lng >= -180 && point.lng <= 180
                        );
                        
                        if (validCoordinates.length < 2) {
                            console.error('Not enough valid coordinates:', validCoordinates.length);
                            throw new Error('Invalid coordinates');
                        }
                        
                        // Karmaşık rotalar için önemli noktaları seç
                        const startPoint = validCoordinates[0];
                        const endPoint = validCoordinates[validCoordinates.length - 1];
                        
                        console.log('Start point:', startPoint);
                        console.log('End point:', endPoint);
                        
                        // Rota uzunluğuna göre strateji belirle
                        if (validCoordinates.length > 100) {
                            // Çok uzun rota - önemli dönüş noktalarını seç
                            const step = Math.floor(validCoordinates.length / 10); // 10 önemli nokta
                            const importantPoints = [];
                            
                            for (let i = 0; i < validCoordinates.length; i += step) {
                                if (importantPoints.length < 10) {
                                    importantPoints.push(validCoordinates[i]);
                                }
                            }
                            
                            // Son noktayı ekle
                            if (importantPoints[importantPoints.length - 1] !== endPoint) {
                                importantPoints.push(endPoint);
                            }
                            
                            // Google Maps URL'si oluştur
                            const pointsStr = importantPoints.map(point => 
                                `${point.lat.toFixed(6)},${point.lng.toFixed(6)}`
                            ).join('/');
                            
                            const googleMapsUrl = `https://www.google.com/maps/dir/${pointsStr}`;
                            console.log('Opening Google Maps with complex route:', googleMapsUrl);
                            window.open(googleMapsUrl, '_blank');
                            return;
                        } else {
                            // Kısa rota - tüm noktaları kullan
                            const pointsStr = validCoordinates.map(point => 
                                `${point.lat.toFixed(6)},${point.lng.toFixed(6)}`
                            ).join('/');
                            
                            const googleMapsUrl = `https://www.google.com/maps/dir/${pointsStr}`;
                            console.log('Opening Google Maps with full route:', googleMapsUrl);
                            window.open(googleMapsUrl, '_blank');
                            return;
                        }
                    } else {
                        console.error('Not enough coordinates:', coordinates.length);
                    }
                } catch (error) {
                    console.error('Polyline decode error:', error);
                }
            }
            

            
            // 3. Route verilerinden başlangıç ve bitiş noktalarını al
            if (route.route && route.route.length >= 2) {
                const startPoint = route.route[0];
                const endPoint = route.route[route.route.length - 1];
                const googleMapsUrl = `https://www.google.com/maps/dir/${startPoint.lat},${startPoint.lng}/${endPoint.lat},${endPoint.lng}`;
                console.log('Opening Google Maps with route coordinates:', startPoint, endPoint);
                window.open(googleMapsUrl, '_blank');
                return;
            }
            
            // 4. Alternatif olarak şehir isimlerini kullan
            if (route.summary) {
                const cities = extractCitiesFromSummary(route.summary);
                if (cities.length >= 2) {
                    const googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(cities[0])}/${encodeURIComponent(cities[1])}`;
                    console.log('Opening Google Maps with cities:', cities);
                    window.open(googleMapsUrl, '_blank');
                    return;
                }
            }
            
            console.error('No valid coordinates found for route');
            alert('Bu rota için Google Maps açılamıyor. Lütfen farklı bir rota deneyin.');
        }
        
        // Summary'den şehir isimlerini çıkar
        function extractCitiesFromSummary(summary) {
            const cityNames = [
                'İstanbul', 'Ankara', 'İzmir', 'Bursa', 'Antalya', 'Adana', 'Konya', 'Gaziantep',
                'Mersin', 'Diyarbakır', 'Samsun', 'Denizli', 'Eskişehir', 'Urfa', 'Malatya',
                'Erzurum', 'Van', 'Batman', 'Elazığ', 'İçel', 'Kocaeli', 'Manisa', 'Kayseri',
                'Sivas', 'Balıkesir', 'Kahramanmaraş', 'Tekirdağ', 'Sakarya', 'Aydın', 'Muğla'
            ];
            
            const foundCities = [];
            for (const city of cityNames) {
                if (summary.toLowerCase().includes(city.toLowerCase())) {
                    foundCities.push(city);
                }
            }
            return foundCities;
        }

        // Harita tam ekran değişikliklerini dinle
        document.addEventListener('fullscreenchange', function() {
            const mapContainer = document.getElementById('map');
            if (document.fullscreenElement) {
                mapContainer.style.borderRadius = '0';
                mapContainer.style.height = '100vh';
            } else {
                mapContainer.style.borderRadius = 'var(--border-radius)';
                mapContainer.style.height = '700px';
            }
            // Haritayı yeniden boyutlandır
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        });
    </script>
</body>
</html> 