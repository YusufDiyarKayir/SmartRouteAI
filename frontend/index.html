<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SmartRouteAI - Harita</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
   body {
    background: linear-gradient(to bottom right, #1e1e2f, #2e2e3f);
    font-family: 'Segoe UI', 'Arial', sans-serif;
    color: #2a3d66;
    margin: 0;
    padding: 0;
}


h2 {
    text-align: center;
    margin-top: 2rem;
    font-size: 2rem;
    color: white;
}

#map {
    height: 600px;
    width: 100%;
    border-radius: 1.25rem;
    box-shadow: 0 0.5rem 1.25rem rgba(0, 0, 0, 0.1);
}

.coords {
    max-width: 900px;
    margin: 1rem auto;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
}

.coords label {
    background: #fff;
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
    font-size: 1rem;
    display: flex;
    align-items: center;
    position: relative;
}

.coords label::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 2px;
    background: #2a3d66;
    bottom: 0;
    left: 0;
    transition: width 0.3s ease-in-out;
}

.coords label:hover::after {
    width: 100%;
}

.coords select,
#params-form input[type="date"],
#params-form input[type="time"] {
    margin-left: 0.5rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    border: 1px solid #bfc8e6;
    background-color: #f8fafd;
    font-size: 1rem;
    transition: border 0.3s ease;
}

.coords select:focus,
#params-form input[type="date"]:focus,
#params-form input[type="time"]:focus {
    border: 2px solid #2a3d66;
    outline: none;
    background-color: #fff;
}

#params-form label {
    margin: 0.5rem 1rem;
    font-size: 1.1rem;
}

#params-form button {
    background-color: #2a3d66;
    color: #fff;
    border: none;
    border-radius: 0.6rem;
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

#params-form button:hover {
    background-color: #1a2540;
}

#reset-btn {
    background-color: #e74c3c;
    color: #fff;
    border: none;
    border-radius: 0.6rem;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    margin: 1rem auto;
    display: block;
    transition: background-color 0.3s ease;
}

#reset-btn:hover {
    background-color: #c0392b;
}

#result {
    background-color: #fff;
    border-radius: 0.75rem;
    padding: 1rem;
    font-size: 1.2rem;
    color: #2a3d66;
    text-align: center;
    max-width: 900px;
    margin: 1rem auto;
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
}

#route-options {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.route-card {
    background-color: #f8fafd;
    border-radius: 0.75rem;
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
    padding: 0.6rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    margin-bottom: 0.3rem;
}

.route-card:hover {
    transform: scale(1.02);
    border-color: #2a3d66;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.route-card.selected {
    border-color: #2a3d66;
    background-color: #e8f0ff;
    box-shadow: 0 0.5rem 1rem rgba(42, 61, 102, 0.2);
}

.route-title {
    font-weight: bold;
    color: #2a3d66;
}

.route-info {
    color: #3a4a6a;
}

.route-toll {
    background-color: #e0e6f0;
    color: #2a3d66;
    border-radius: 0.5rem;
    padding: 0.2rem 0.6rem;
    font-size: 0.95rem;
}

.route-details-card {
    background-color: #fff;
    border-radius: 0.75rem;
    box-shadow: 0 0.25rem 1rem rgba(60, 60, 100, 0.1);
    padding: 1.5rem;
    font-size: 1.1rem;
    color: #2a3d66;
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.route-details-card div {
    min-width: 180px;
}

.weather-main {
    font-weight: bold;
    color: #1a2540;
}

.weather-impact {
    color: #e74c3c;
    font-weight: bold;
    font-style: italic;
}

        /* ≈ûehir isimleri i√ßin √∂zel stiller */
        .city-label {
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            pointer-events: none;
            transform: translate(-50%, -100%);
            position: absolute;
            margin: 0;
            line-height: 1.2;
        }

        .city-label.start {
            border-color: #2ecc71;
            color: #27ae60;
            background: rgba(46, 204, 113, 0.25);
            font-size: 20px;
            padding: 15px 20px;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: pulse-green 2s infinite;
            font-weight: 900;
            border-width: 4px;
        }

        .city-label.end {
            border-color: #e74c3c;
            color: #c0392b;
            background: rgba(231, 76, 60, 0.25);
            font-size: 20px;
            padding: 15px 20px;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: pulse-red 2s infinite;
            font-weight: 900;
            border-width: 4px;
        }

        .city-label.waypoint {
            border-color: #f39c12;
            color: #e67e22;
            background: rgba(243, 156, 18, 0.25);
            font-size: 20px;
            padding: 15px 20px;
            box-shadow: 0 10px 30px rgba(243, 156, 18, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: pulse-orange 2s infinite;
            font-weight: 900;
            border-width: 4px;
        }

        .city-label.other {
            border-color: #3498db;
            color: #2980b9;
            background: rgba(52, 152, 219, 0.25);
            font-size: 20px;
            padding: 15px 20px;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: pulse-blue 2s infinite;
            font-weight: 900;
            border-width: 4px;
        }

        /* Parƒ±ldama animasyonlarƒ± */
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 10px 30px rgba(46, 204, 113, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 15px 40px rgba(46, 204, 113, 0.8), 0 6px 15px rgba(0, 0, 0, 0.4); }
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 10px 30px rgba(231, 76, 60, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 15px 40px rgba(231, 76, 60, 0.8), 0 6px 15px rgba(0, 0, 0, 0.4); }
        }

        @keyframes pulse-orange {
            0%, 100% { box-shadow: 0 10px 30px rgba(243, 156, 18, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 15px 40px rgba(243, 156, 18, 0.8), 0 6px 15px rgba(0, 0, 0, 0.4); }
        }

        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 10px 30px rgba(52, 152, 219, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 15px 40px rgba(52, 152, 219, 0.8), 0 6px 15px rgba(0, 0, 0, 0.4); }
        }

/* ≈ûehir marker'larƒ± i√ßin √∂zel stiller */
.city-marker {
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
}

.city-marker.start {
    filter: drop-shadow(0 4px 8px rgba(46, 204, 113, 0.4));
}

.city-marker.end {
    filter: drop-shadow(0 4px 8px rgba(231, 76, 60, 0.4));
}

.city-marker.waypoint {
    filter: drop-shadow(0 4px 8px rgba(243, 156, 18, 0.4));
}

.city-marker.other {
    filter: drop-shadow(0 4px 8px rgba(52, 152, 219, 0.4));
}

#preset-routes {
    background-color: #f8fafd;
    border-radius: 0.75rem;
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.07);
    padding: 1rem 1.5rem;
    max-width: 320px;
    margin: 2rem 0;
}

.preset-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #2a3d66;
    margin-bottom: 0.75rem;
}

.preset-btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.preset-btn {
    background-color: #2a3d66;
    color: #fff;
    border: none;
    border-radius: 0.5rem;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    transition: background-color 0.2s ease, transform 0.2s ease;
}

.preset-btn:hover {
    background-color: #1a2540;
    transform: scale(1.04);
}

#main-layout {
    display: flex;
    flex-direction: row;
    justify-content: center;
    gap: 2rem;
    max-width: 1400px;
    margin: 0 auto;
    align-items: flex-start;
}

#map {
    flex: 1;
    min-height: 600px;
}

#route-options {
    width: 320px;
    height: 600px;
    overflow-y: auto;
    flex-shrink: 0;
}

@media (max-width: 900px) {
    #main-layout {
        flex-direction: column;
        align-items: stretch;
    }

    #map, #route-options {
        max-width: 98vw;
        margin: 1rem auto;
    }
    
    #route-options {
        min-width: auto;
        max-height: 400px;
    }
}

    </style>
</head>
<body>
    <h2>SmartRouteAI - Prompt ile Rota Olu≈ütur</h2>
    <div id="prompt-section" style="max-width:900px;margin:2em auto 1em auto;padding:1.5em 2em;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;flex-direction:column;gap:1em;">
        <label for="prompt-input" style="font-size:1.15em;font-weight:bold;">Promptunuzu girin:</label>
        <textarea id="prompt-input" rows="2" placeholder="√ñrn: ƒ∞stanbul'dan Antalya'ya Aralƒ±k ayƒ±nda gitmek istiyorum" style="font-size:1.25em;padding:1.1em 1em;border-radius:14px;border:1.5px solid #bfc8e6;resize:vertical;min-height:3.5em;box-shadow:0 1px 6px rgba(60,60,100,0.07);transition: border 0.3s, box-shadow 0.3s;outline:none;background:#f8fafd;line-height:1.5;"></textarea>
        <div style="margin-top:0.5em;font-size:0.9em;color:#666;">
            <strong>√ñrnek promptlar:</strong><br>
            ‚Ä¢ "ƒ∞stanbul'dan Antalya'ya Aralƒ±k ayƒ±nda gitmek istiyorum"<br>
            ‚Ä¢ "Ocak ayƒ±nda ƒ∞stanbul Kars Antalya rotasƒ±"<br>
            ‚Ä¢ "Haziran'da ƒ∞zmir'den Ankara'ya yolculuk"
        </div>
        <style>
        #prompt-input:focus {
            border: 2px solid #2a3d66;
            box-shadow: 0 2px 12px 0 rgba(60,60,100,0.13);
            background: #fff;
        }
        #prompt-input::placeholder {
            color: #b0b0b0;
            font-style: italic;
            opacity: 1;
        }
        </style>
        <div style="display:flex;gap:1em;align-items:center;">
            <button id="route-weather-btn" style="background:#2a3d66;color:#fff;border:none;border-radius:8px;padding:0.7em 1.5em;font-size:1.1em;cursor:pointer;box-shadow:0 2px 8px 0 rgba(60,60,100,0.10);">üöó Rota Olu≈ütur ve Hava Durumu Analiz Et</button>
        </div>
        <div id="prompt-result" style="margin-top:1em;font-size:1.1em;"></div>
        <div id="weather-result" style="margin-top:1em;font-size:1.1em;display:none;background:#f0f8ff;padding:1em;border-radius:8px;border-left:4px solid #4CAF50;"></div>
    </div>
    <div id="main-layout">
        <div id="map"></div>
        <div id="route-options" style="width:320px;height:600px;margin:0;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:0.5em;overflow-y:auto;flex-shrink:0;"></div>
    </div>
    <div id="result" style="font-weight:bold;"></div>
    <div id="route-details" style="max-width:900px;margin:1em auto 0 auto;"></div>
    <div class="coords" style="display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:2em auto;padding:1.5em 2em;background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08);flex-wrap:wrap;gap:1em;">
        <label>Ba≈ülangƒ±√ß:
            <select id="from-place">
                <option value="">Haritadan se√ß</option>
                <option value="41.038946,28.813249">LCWAIKIKI GENEL MUDURLUK</option>
                <option value="41.060634,28.659207">LCWAIKIKI LOJISTIK MERKEZ</option>
                <option value="40.653129,29.354463">LCWAIKIKI YALOVA DEPO</option>
            </select>
            <span id="from-coord">Se√ßilmedi</span>
        </label>
        <label>Hedef:
            <select id="to-place">
                <option value="">Haritadan se√ß</option>
                <option value="41.038946,28.813249">LCWAIKIKI GENEL MUDURLUK</option>
                <option value="41.060634,28.659207">LCWAIKIKI LOJISTIK MERKEZ</option>
                <option value="40.653129,29.354463">LCWAIKIKI YALOVA DEPO</option>
            </select>
            <span id="to-coord">Se√ßilmedi</span>
        </label>
        <label>Tarih:
            <input type="date" id="date-input" style="margin-left:0.5em;">
        </label>
        <label>Saat:
            <input type="time" id="time-input" style="margin-left:0.5em;">
        </label>
        <button id="route-btn" style="padding:0.7em 1.5em;font-size:1.1em;background:#2a3d66;color:#fff;border:none;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px 0 rgba(60,60,100,0.10);">Rotayƒ± Hesapla</button>
        <button id="reset-btn" style="padding:0.6em 1.2em;font-size:1em;background:#e74c3c;color:#fff;border:none;border-radius:8px;cursor:pointer;">Sƒ±fƒ±rla</button>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Polyline decode (Google polyline formatƒ±) - Sadele≈ütirilmi≈ü versiyon
        function decodePolyline(encoded) {
            if (!encoded || encoded.length === 0) {
                console.warn('Empty polyline data');
                return [];
            }
            
            let points = [];
            let index = 0, len = encoded.length;
            let lat = 0, lng = 0;
            
            try {
                while (index < len) {
                    let b, shift = 0, result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lat += dlat;
                    shift = 0;
                    result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lng += dlng;
                    points.push([lat / 1e5, lng / 1e5]);
                }
                
                console.log(`Decoded ${points.length} points from polyline`);
                return points;
            } catch (error) {
                console.error('Error decoding polyline:', error);
                return [];
            }
        }
        const map = L.map('map').setView([41.0082, 28.9784], 10); // ƒ∞stanbul merkezli
        // Google Maps tile layer T√ºrk√ße ≈üehir isimleri ile
        L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}&hl=tr', {
            maxZoom: 20,
            attribution: '¬© Google Maps',
            updateWhenZooming: false,
            updateWhenIdle: true
        }).addTo(map);

        let fromMarker = null;
        let toMarker = null;
        let fromCoord = null;
        let toCoord = null;
        let routeLine = null;
        let currentRoute = null;
        let allRoutes = [];
        let selectedRouteIndex = null;

        function updateCoords() {
            document.getElementById('from-coord').textContent = fromCoord ? `${fromCoord.lat.toFixed(5)}, ${fromCoord.lng.toFixed(5)}` : 'Se√ßilmedi';
            document.getElementById('to-coord').textContent = toCoord ? `${toCoord.lat.toFixed(5)}, ${toCoord.lng.toFixed(5)}` : 'Se√ßilmedi';
        }

        function showRouteOptions(routes) {
            const container = document.getElementById('route-options');
            container.innerHTML = '<h3 style="margin:0;color:black;font-size:1.2rem;">üõ£Ô∏è Alternatif Rotalar</h3>';
            if (!routes || routes.length === 0) {
                container.innerHTML += '<p style="color:#666;text-align:center;margin:1rem 0;">Hen√ºz rota olu≈üturulmadƒ±</p>';
                return;
            }
            routes.forEach((route, idx) => {
                console.log(`[FRONTEND] Route ${idx}:`, route);
                const div = document.createElement('div');
                div.className = 'route-card' + (selectedRouteIndex === idx ? ' selected' : '');
                div.onclick = function() { selectRoute(idx); };
                // S√ºre bilgileri hazƒ±rlanƒ±yor
                
                div.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 1px;">
                        <span class="route-title" style="font-size: 0.7em;">${route.title || `Rota ${idx + 1}`}</span>
                        <span class="route-title" style="font-size: 0.7em;">${route.distanceKm || 0} KM</span>
                        
                        <!-- Normal varƒ±≈ü s√ºresi -->
                        <span class="route-info" style="color: #28a745; font-weight: bold; font-size: 0.6em;">Normal: ${formatDuration(route.durationMin || route.estimatedDurationMinutes)}</span>
                        
                        <!-- Hava ≈üartlarƒ± nedeniyle varƒ±≈ü s√ºresi (eƒüer varsa) -->
                        ${route.durationType === "weather" || route.durationType === "combined" ? 
                            `<span class="route-info" style="color: #ffc107; font-weight: bold; font-size: 0.6em;">Hava: ${formatDuration(route.weatherDurationMin || route.adjustedDurationMin)}</span>` : ''}
                        
                        <!-- Tatil g√ºn√º nedeniyle varƒ±≈ü s√ºresi (eƒüer varsa) -->
                        ${route.durationType === "holiday" || route.durationType === "combined" ? 
                            `<span class="route-info" style="color: #dc3545; font-weight: bold; font-size: 0.6em;">Tatil: ${formatDuration(route.holidayDurationMin || route.adjustedDurationMin)}</span>` : ''}
                        
                        <!-- Hava ≈üartlarƒ± ve tatil nedeniyle varƒ±≈ü s√ºresi (eƒüer varsa) -->
                        ${route.durationType === "combined" ? 
                            `<span class="route-info" style="color: #17a2b8; font-weight: bold; font-size: 0.6em;">Hava+Tatil: ${formatDuration(route.combinedDurationMin || route.adjustedDurationMin)}</span>` : ''}
                        
                        <!-- TAHMƒ∞Nƒ∞ VARƒ∞≈û - Kƒ±rmƒ±zƒ± ve b√ºy√ºk -->
                        <span class="route-info" style="color: #dc3545; font-size: 0.8em; font-weight: bold; margin-top: 1px;">TAHMƒ∞Nƒ∞: ${formatDuration(route.adjustedDurationMin || route.estimatedDurationMinutes)}</span>
                        
                        <span class="route-toll" style="font-size: 0.6em;">Otoyol: ${route.tollClass || '√úcretsiz'}</span>
                    </div>`;
                container.appendChild(div);
            });
        }

        function showRouteDetails(route) {
            const details = document.getElementById('route-details');
            if (!route) { details.innerHTML = ''; return; }
            // S√ºre bilgileri hazƒ±rlanƒ±yor
            
            details.innerHTML = `
                <div class="route-details-card">
                    <div style="font-size: 0.65em;"><b>Mesafe:</b> ${route.distanceKm || 0} km</div>
                    
                    <!-- Normal varƒ±≈ü s√ºresi -->
                    <div style="background: #e8f5e8; padding: 3px; border-radius: 2px; margin: 2px 0; font-size: 0.6em;">
                        <b style="color: #28a745;">Normal:</b> ${formatDuration(route.durationMin || route.estimatedDurationMinutes)}
                    </div>
                    
                    <!-- Hava ≈üartlarƒ± nedeniyle varƒ±≈ü s√ºresi (eƒüer varsa) -->
                    ${route.durationType === "weather" || route.durationType === "combined" ? `
                    <div style="background: #fff3cd; padding: 3px; border-radius: 2px; margin: 2px 0; font-size: 0.6em;">
                        <b style="color: #ffc107;">Hava:</b> ${formatDuration(route.weatherDurationMin || route.adjustedDurationMin)}
                    </div>
                    ` : ''}
                    
                    <!-- Tatil g√ºn√º nedeniyle varƒ±≈ü s√ºresi (eƒüer varsa) -->
                    ${route.durationType === "holiday" || route.durationType === "combined" ? `
                    <div style="background: #f8d7da; padding: 3px; border-radius: 2px; margin: 2px 0; font-size: 0.6em;">
                        <b style="color: #dc3545;">Tatil:</b> ${formatDuration(route.holidayDurationMin || route.adjustedDurationMin)}
                    </div>
                    ` : ''}
                    
                    <!-- Hava ≈üartlarƒ± ve tatil nedeniyle varƒ±≈ü s√ºresi (eƒüer varsa) -->
                    ${route.durationType === "combined" ? `
                    <div style="background: #d1ecf1; padding: 3px; border-radius: 2px; margin: 2px 0; font-size: 0.6em;">
                        <b style="color: #17a2b8;">Hava+Tatil:</b> ${formatDuration(route.combinedDurationMin || route.adjustedDurationMin)}
                    </div>
                    ` : ''}
                    
                    <!-- TAHMƒ∞Nƒ∞ VARƒ∞≈û - Kƒ±rmƒ±zƒ± ve b√ºy√ºk -->
                    <div style="background: #dc3545; color: white; padding: 3px; border-radius: 2px; margin: 3px 0; text-align: center;">
                        <b style="font-size: 0.85em;">TAHMƒ∞Nƒ∞: ${formatDuration(route.adjustedDurationMin || route.estimatedDurationMinutes)}</b>
                    </div>
                    
                    <div style="font-size: 0.65em;"><b>Tahmini varƒ±≈ü:</b> ${route.arrivalStr || route.arrivalstr || '-'} </div>
                    <div style="font-size: 0.65em;"><b>Beklenen hava:</b> <span class="weather-main">${route.weatherDesc || route.weatherdesc ? (route.weatherDesc || route.weatherdesc).charAt(0).toUpperCase() + (route.weatherDesc || route.weatherdesc).slice(1) : (route.weather || '-')}</span></div>
                    <div style="font-size: 0.65em;"><b>Hava etkisi:</b> <span class="weather-impact">${route.weatherImpact || 'Yok'}</span></div>
                    <div style="font-size: 0.65em;"><b>Otoyol:</b> <span class="route-toll">${route.tollClass || '√úcretsiz'}</span></div>
                    <div style="font-size: 0.65em;"><b>√úcretli ge√ßi≈ü:</b> <span class="route-toll">${route.tollInfo || route.tollinfo || '-'}</span></div>
                </div>
            `;
        }

        function selectRoute(idx) {
            selectedRouteIndex = idx;
            showRouteOptions(allRoutes);
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            const route = allRoutes[idx];
            if (route.polyline && route.polyline.length > 0) {
                const latlngs = decodePolyline(route.polyline);
                if (latlngs.length > 1) {
                    routeLine = L.polyline(latlngs, {
                        color: '#6b5ac6', 
                        weight: 8, 
                        opacity: 0.5,
                        smoothFactor: 1,
                        lineCap: 'round',
                        lineJoin: 'round'
                    }).addTo(map);
                    routeLine.setZIndex(50); // ≈ûehir isimlerinin arkasƒ±na ge√ßmesi i√ßin √ßok d√º≈ü√ºk z-index
                    map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                    updateRouteStyle();
                } else {
                    console.warn('Route polyline decoded but insufficient points');
                }
            }
            showRouteDetails(route);
        }

        // Dropdown se√ßimleri
        document.getElementById('from-place').onchange = function() {
            const val = this.value;
            if (val) {
                const [lat, lng] = val.split(',').map(Number);
                fromCoord = { lat, lng };
                if (fromMarker) { map.removeLayer(fromMarker); }
                fromMarker = L.marker([lat, lng], { draggable: true }).addTo(map).bindPopup('Ba≈ülangƒ±√ß').openPopup();
                fromMarker.on('dragend', function(ev) {
                    fromCoord = ev.target.getLatLng();
                    document.getElementById('from-place').value = '';
                    updateCoords();
                });
                map.setView([lat, lng], 12);
                updateCoords();
            } else {
                if (fromMarker) { map.removeLayer(fromMarker); fromMarker = null; fromCoord = null; updateCoords(); }
            }
        };
        document.getElementById('to-place').onchange = function() {
            const val = this.value;
            if (val) {
                const [lat, lng] = val.split(',').map(Number);
                toCoord = { lat, lng };
                if (toMarker) { map.removeLayer(toMarker); }
                toMarker = L.marker([lat, lng], { draggable: true, icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32,32], iconAnchor: [16,32]}) }).addTo(map).bindPopup('Hedef').openPopup();
                toMarker.on('dragend', function(ev) {
                    toCoord = ev.target.getLatLng();
                    document.getElementById('to-place').value = '';
                    updateCoords();
                });
                map.setView([lat, lng], 12);
                updateCoords();
            } else {
                if (toMarker) { map.removeLayer(toMarker); toMarker = null; toCoord = null; updateCoords(); }
            }
        };

        // Haritadan tƒ±klama
        map.on('click', function(e) {
            if (!fromMarker) {
                fromCoord = e.latlng;
                fromMarker = L.marker(e.latlng, { draggable: true }).addTo(map).bindPopup('Ba≈ülangƒ±√ß').openPopup();
                fromMarker.on('dragend', function(ev) {
                    fromCoord = ev.target.getLatLng();
                    document.getElementById('from-place').value = '';
                    updateCoords();
                });
                document.getElementById('from-place').value = '';
            } else if (!toMarker) {
                toCoord = e.latlng;
                toMarker = L.marker(e.latlng, { draggable: true, icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32,32], iconAnchor: [16,32]}) }).addTo(map).bindPopup('Hedef').openPopup();
                toMarker.on('dragend', function(ev) {
                    toCoord = ev.target.getLatLng();
                    document.getElementById('to-place').value = '';
                    updateCoords();
                });
                document.getElementById('to-place').value = '';
            }
            updateCoords();
        });

        document.getElementById('reset-btn').onclick = function() {
            if (fromMarker) { map.removeLayer(fromMarker); fromMarker = null; fromCoord = null; }
            if (toMarker) { map.removeLayer(toMarker); toMarker = null; toCoord = null; }
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            currentRoute = null;
            
            // ≈ûehir etiketlerini temizle
            clearCityLabels();
            promptCities = [];
            
            updateCoords();
            document.getElementById('result').textContent = '';
            document.getElementById('route-details').innerHTML = ''; // Sƒ±fƒ±rlama
        };

        function updateRouteStyle() {
            if (!routeLine) return;
            const zoom = map.getZoom();
            if (zoom < 12) {
                routeLine.setStyle({ 
                    color: '#6b5ac6', 
                    weight: 10, 
                    opacity: 0.8,
                    smoothFactor: 1,
                    lineCap: 'round',
                    lineJoin: 'round'
                });
            } else if (zoom < 15) {
                routeLine.setStyle({ 
                    color: '#6b5ac6', 
                    weight: 8, 
                    opacity: 0.8,
                    smoothFactor: 1,
                    lineCap: 'round',
                    lineJoin: 'round'
                });
            } else {
                routeLine.setStyle({ 
                    color: '#6b5ac6', 
                    weight: 6, 
                    opacity: 0.8,
                    smoothFactor: 1,
                    lineCap: 'round',
                    lineJoin: 'round'
                });
            }
        }
        map.on('zoomend', updateRouteStyle);

        document.getElementById('route-btn').onclick = async function() {
            if (!fromCoord || !toCoord) {
                alert('L√ºtfen haritadan veya listeden ba≈ülangƒ±√ß ve hedef se√ßin!');
                return;
            }
            const date = document.getElementById('date-input').value;
            const time = document.getElementById('time-input').value;
            if (!date || !time) {
                alert('L√ºtfen tarih ve saat se√ßin!');
                return;
            }
            const data = {
                fromLat: fromCoord.lat,
                fromLng: fromCoord.lng,
                toLat: toCoord.lat,
                toLng: toCoord.lng,
                date,
                time
            };
            console.log('[FRONTEND] Sending route request:', data);
            document.getElementById('result').textContent = 'Hesaplanƒ±yor...';
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            currentRoute = null;
            try {
                const resp = await fetch('http://localhost:5077/route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await resp.json();
                if (result.error) {
                    document.getElementById('result').textContent = 'Hata: ' + result.error;
                } else if (result.routes && result.routes.length > 0) {
                    allRoutes = result.routes;
                    selectedRouteIndex = 0;
                    showRouteOptions(allRoutes);
                    document.getElementById('result').textContent = '';
                    selectRoute(0);
                } else {
                    document.getElementById('result').textContent = `Mesafe: ${result.distanceKm} km, Tahmini S√ºre: ${formatDuration(result.adjustedDurationMin || result.estimatedDurationMinutes)}`;
                    if (result.polyline) {
                        const latlngs = decodePolyline(result.polyline);
                        routeLine = L.polyline(latlngs, {
                            color: '#6b5ac6', 
                            weight: 8, 
                            opacity: 0.8,
                            smoothFactor: 1,
                            lineCap: 'round',
                            lineJoin: 'round'
                        }).addTo(map);
                        routeLine.setZIndex(50); // ≈ûehir isimlerinin arkasƒ±na ge√ßmesi i√ßin √ßok d√º≈ü√ºk z-index
                        map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                        updateRouteStyle();
                    } else if (result.distanceKm > 0) {
                        alert('Yol bulundu ama rota √ßizilemedi. Mesafe: ' + result.distanceKm + ' km');
                    } else {
                        alert('Backendden rota verisi gelmedi veya bo≈ü. L√ºtfen farklƒ± bir g√ºzergah deneyin.');
                    }
                }
            } catch (err) {
                document.getElementById('result').textContent = 'Sunucuya ula≈üƒ±lamƒ±yor.';
            }
        };

        // Eski prompt-btn event listener'ƒ± kaldƒ±rƒ±ldƒ± - artƒ±k route-weather-btn kullanƒ±lƒ±yor
        
        // Haritada rota g√∂sterme fonksiyonu
        function showRouteOnMap(polyline) {
            if (fromMarker) { map.removeLayer(fromMarker); fromMarker = null; }
            if (toMarker) { map.removeLayer(toMarker); toMarker = null; }
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            if (window._cityMarkers) window._cityMarkers.forEach(m => map.removeLayer(m));
            window._cityMarkers = [];
            
            if (polyline && polyline.length > 0) {
                const latlngs = decodePolyline(polyline);
                if (latlngs.length > 1) {
                    routeLine = L.polyline(latlngs, {
                        color: '#6b5ac6', 
                        weight: 6, 
                        opacity: 0.8,
                        smoothFactor: 1
                    }).addTo(map);
                    routeLine.setZIndex(50); // ≈ûehir isimlerinin arkasƒ±na ge√ßmesi i√ßin √ßok d√º≈ü√ºk z-index
                    map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                }
            }
        }

        // Prompt ≈üehirlerini haritada g√∂ster
        function showPromptCitiesOnMap() {
            if (!promptCities || promptCities.length === 0) return;
            
            // _cityMarkers dizisini ba≈ülat
            if (!window._cityMarkers) {
                window._cityMarkers = [];
            }
            
            promptCities.forEach((cityName, index) => {
                const cityData = cityCenters[cityName];
                if (cityData) {
                    const [lat, lng] = cityData;
                    let type = 'other';
                    let icon = otherIcon;
                    
                    // ƒ∞lk ≈üehir ba≈ülangƒ±√ß, son ≈üehir hedef, diƒüerleri ara durak
                    if (index === 0) {
                        type = 'start';
                        icon = startIcon;
                    } else if (index === promptCities.length - 1) {
                        type = 'end';
                        icon = endIcon;
                    } else {
                        type = 'waypoint';
                        icon = waypointIcon;
                    }
                    
                    // ≈ûehir marker'ƒ±nƒ± ekle
                    const marker = L.marker([lat, lng], { icon: icon }).addTo(map);
                    marker.bindPopup(`<b>${cityName}</b><br>${type === 'start' ? 'üöÄ Ba≈ülangƒ±√ß' : type === 'end' ? 'üéØ Hedef' : 'üìç Ara Durak'}`);
                    window._cityMarkers.push(marker);
                    
                    // ≈ûehir etiketini ekle (kapatƒ±ldƒ± - sadece marker kalsƒ±n)
                    // addCityLabel(cityName, [lat, lng], type);
                }
            });
        }
        
        // ≈ûehir merkezleri koordinatlarƒ± (√∂rnek, T√ºrkiye'nin b√ºy√ºk ≈üehirleri)
        const cityCenters = {
            "Adana": [37.0, 35.3213], "Adƒ±yaman": [37.7648, 38.2786], "Afyonkarahisar": [38.7638, 30.5403], "Aƒürƒ±": [39.7191, 43.0503], "Amasya": [40.6539, 35.8336], "Ankara": [39.9334, 32.8597], "Antalya": [36.8969, 30.7133], "Artvin": [41.1828, 41.8183], "Aydƒ±n": [37.8450, 27.8396], "Balƒ±kesir": [39.6484, 27.8826], "Bilecik": [40.1428, 29.9793], "Bing√∂l": [39.0626, 40.7696], "Bitlis": [38.4011, 42.1078], "Bolu": [40.5760, 31.5788], "Burdur": [37.7203, 30.2908], "Bursa": [40.1826, 29.0665], "√áanakkale": [40.1553, 26.4142], "√áankƒ±rƒ±": [40.6013, 33.6134], "√áorum": [40.5506, 34.9556], "Denizli": [37.7765, 29.0864], "Diyarbakƒ±r": [37.9144, 40.2306], "Edirne": [41.6771, 26.5557], "Elazƒ±ƒü": [38.6743, 39.2232], "Erzincan": [39.7500, 39.5000], "Erzurum": [39.9043, 41.2679], "Eski≈üehir": [39.7767, 30.5206], "Gaziantep": [37.0662, 37.3833], "Giresun": [40.9128, 38.3895], "G√ºm√º≈ühane": [40.4603, 39.4814], "Hakkari": [37.5744, 43.7408], "Hatay": [36.2021, 36.1600], "Isparta": [37.7648, 30.5566], "Mersin": [36.8121, 34.6415], "ƒ∞stanbul": [41.0082, 28.9784], "ƒ∞zmir": [38.4192, 27.1287], "Kars": [40.6013, 43.0975], "Kastamonu": [41.3897, 33.7827], "Kayseri": [38.7312, 35.4787], "Kƒ±rklareli": [41.7351, 27.2250], "Kƒ±r≈üehir": [39.1458, 34.1606], "Kocaeli": [40.8533, 29.8815], "Konya": [37.8746, 32.4932], "K√ºtahya": [39.4242, 29.9833], "Malatya": [38.3552, 38.3095], "Manisa": [38.6191, 27.4289], "Kahramanmara≈ü": [37.5736, 36.9371], "Mardin": [37.3212, 40.7245], "Muƒüla": [37.2153, 28.3636], "Mu≈ü": [38.9462, 41.7539], "Nev≈üehir": [38.6244, 34.7236], "Niƒüde": [37.9667, 34.6833], "Ordu": [40.9847, 37.8789], "Rize": [41.0256, 40.5177], "Sakarya": [40.7569, 30.3781], "Samsun": [41.2867, 36.33], "Siirt": [37.9274, 41.9456], "Sinop": [42.0267, 35.1551], "Sivas": [39.7477, 37.0179], "Tekirdaƒü": [40.9780, 27.5110], "Tokat": [40.3167, 36.5544], "Trabzon": [41.0015, 39.7178], "Tunceli": [39.1081, 39.5483], "≈ûanlƒ±urfa": [37.1674, 38.7955], "U≈üak": [38.6823, 29.4082], "Van": [38.5019, 43.4167], "Yozgat": [39.8181, 34.8147], "Zonguldak": [41.4564, 31.7987], "Aksaray": [38.3687, 34.0360], "Bayburt": [40.2567, 40.2249], "Karaman": [37.1759, 33.2287], "Kƒ±rƒ±kkale": [39.8468, 33.5153], "Batman": [37.8812, 41.1351], "≈ûƒ±rnak": [37.4187, 42.4918], "Bartƒ±n": [41.6358, 32.3375], "Ardahan": [41.1105, 42.7022], "Iƒüdƒ±r": [39.9237, 44.0450], "Yalova": [40.6500, 29.2667], "Karab√ºk": [41.2061, 32.6204], "Kilis": [36.7184, 37.1212], "Osmaniye": [37.0742, 36.2478], "D√ºzce": [40.8438, 31.1565]
        };
        // ≈ûehir e≈üle≈ütirme i√ßin normalize edilmi≈ü map
        const turkishMap = { 'ƒ∞':'I', 'ƒ±':'i', '≈û':'S', '≈ü':'s', 'ƒû':'G', 'ƒü':'g', '√ú':'U', '√º':'u', '√ñ':'O', '√∂':'o', '√á':'C', '√ß':'c' };
        function normalize(str) { return str.replace(/[ƒ∞ƒ±≈û≈üƒûƒü√ú√º√ñ√∂√á√ß]/g, c => turkishMap[c] || c).toLowerCase(); }
        const cityCentersMap = {};
        for (const key in cityCenters) { cityCentersMap[normalize(key)] = key; }
        
        // √ñzel ≈üehir marker ikonlarƒ±
        const startIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', 
            iconSize: [40, 40], 
            iconAnchor: [20, 40],
            className: 'city-marker start'
        });
        const endIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/149/149059.png', 
            iconSize: [40, 40], 
            iconAnchor: [20, 40],
            className: 'city-marker end'
        });
        const waypointIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png', 
            iconSize: [36, 36], 
            iconAnchor: [18, 36],
            className: 'city-marker waypoint'
        });
        const otherIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png', 
            iconSize: [32, 32], 
            iconAnchor: [16, 32],
            className: 'city-marker other'
        });

        // Prompt'tan √ßƒ±karƒ±lan ≈üehirleri takip etmek i√ßin global deƒüi≈üken
        let promptCities = [];
        let cityLabels = [];

        // ≈ûehir etiketlerini temizle
        function clearCityLabels() {
            // ≈ûehir etiketlerini temizle
            cityLabels.forEach(label => {
                if (label && map.hasLayer(label)) {
                    map.removeLayer(label);
                }
            });
            cityLabels = [];
            
            // Eski ≈üehir marker'larƒ±nƒ± da temizle
            if (window._cityMarkers && Array.isArray(window._cityMarkers)) {
                window._cityMarkers.forEach(marker => {
                    if (marker && map.hasLayer(marker)) {
                        map.removeLayer(marker);
                    }
                });
                window._cityMarkers = [];
            }
            
            // Eski rota √ßizgilerini temizle
            if (routeLine && map.hasLayer(routeLine)) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
        }

        // ≈ûehir etiketlerini ekle
        function addCityLabel(cityName, coords, type) {
            const label = L.divIcon({
                className: `city-label ${type}`,
                html: `<div style="font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${cityName}</div>`,
                iconSize: [150, 50],
                iconAnchor: [75, 50]
            });
            
            const marker = L.marker(coords, { icon: label }).addTo(map);
            cityLabels.push(marker);
            return marker;
        }

        // Enter tu≈üu ile birle≈üik rota ve hava durumu analizi
        const promptInput = document.getElementById('prompt-input');
        promptInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('route-weather-btn').click();
            }
        });

        // Dakikayƒ± "X Saat Y Dakika" formatƒ±na √ßeviren yardƒ±mcƒ± fonksiyon
        function formatDuration(minutes) {
            if (!minutes || minutes <= 0) return '0 Dakika';
            
            // Ondalƒ±k kƒ±smƒ± temizle
            const cleanMinutes = Math.round(minutes);
            const hours = Math.floor(cleanMinutes / 60);
            const mins = cleanMinutes % 60;
            
            if (hours === 0) {
                return `${mins} Dakika`;
            } else if (mins === 0) {
                return `${hours} Saat`;
            } else {
                return `${hours} Saat ${mins} Dakika`;
            }
        }

        // Advanced hava durumu analizi fonksiyonu
        async function analyzeWeatherFromPrompt(prompt) {
            const weatherResult = document.getElementById('weather-result');
            weatherResult.style.display = 'block';
            weatherResult.innerHTML = '<div style="text-align:center;color:#666;">üå§Ô∏è Advanced hava durumu analiz ediliyor...</div>';
            
            // Tarih analizi
            const datePatterns = [
                /(\d{1,2})\.(\d{1,2})\.(\d{4})/g, // DD.MM.YYYY formatƒ±
                /(\d{1,2})\s*(ocak|≈üubat|mart|nisan|mayƒ±s|haziran|temmuz|aƒüustos|eyl√ºl|ekim|kasƒ±m|aralƒ±k)/gi,
                /(\d{1,2})\s*(january|february|march|april|may|june|july|august|september|october|november|december)/gi
            ];
            
            let foundDate = null;
            let foundCities = [];
            
            // Ay haritasƒ±
            const monthMap = {
                'ocak': 1, 'january': 1, '≈üubat': 2, 'february': 2, 'mart': 3, 'march': 3,
                'nisan': 4, 'april': 4, 'mayƒ±s': 5, 'may': 5, 'haziran': 6, 'june': 6,
                'temmuz': 7, 'july': 7, 'aƒüustos': 8, 'august': 8, 'eyl√ºl': 9, 'september': 9,
                'ekim': 10, 'october': 10, 'kasƒ±m': 11, 'november': 11, 'aralƒ±k': 12, 'december': 12
            };
            
            // Tarih bul
            for (let i = 0; i < datePatterns.length; i++) {
                const pattern = datePatterns[i];
                const match = prompt.match(pattern);
                if (match) {
                    if (i === 0) {
                        // DD.MM.YYYY formatƒ±
                        foundDate = {
                            day: parseInt(match[1]),
                            month: parseInt(match[2]),
                            year: parseInt(match[3])
                        };
                    } else {
                        // Ay ismi formatƒ±
                        for (const monthName in monthMap) {
                            if (prompt.toLowerCase().includes(monthName)) {
                                foundDate = {
                                    day: parseInt(match[0].match(/\d+/)[0]),
                                    month: monthMap[monthName],
                                    year: new Date().getFullYear()
                                };
                                break;
                            }
                        }
                    }
                    break;
                }
            }
            
            // ≈ûehirleri bul
            for (const cityName in cityCenters) {
                if (prompt.toLowerCase().includes(cityName.toLowerCase())) {
                    foundCities.push(cityName);
                }
            }
            
            if (foundCities.length === 0) {
                weatherResult.innerHTML = '<div style="color:#f44336;">‚ùå Prompt\'ta ≈üehir bulunamadƒ±!</div>';
                return;
            }
            
            if (!foundDate) {
                weatherResult.innerHTML = '<div style="color:#f44336;">‚ùå Prompt\'ta tarih bulunamadƒ±!</div>';
                return;
            }
            
            // Advanced hava durumu tahmini
            let weatherAnalysis = '<div style="margin-bottom:1em;"><strong>üå§Ô∏è Advanced Hava Durumu Analizi:</strong></div>';
            
            // Advanced ML tabanlƒ± tahmin
            const dateStr = `${foundDate.year}-${foundDate.month.toString().padStart(2, '0')}-${foundDate.day.toString().padStart(2, '0')}`;
            
            try {
                const response = await fetch('http://localhost:5001/predict_route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cities: foundCities,
                        date: dateStr
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const predictions = data.predictions || [];
                    
                    predictions.forEach(prediction => {
                        const city = prediction.city;
                        const weather = prediction.predicted_weather;
                        const temp = Math.round(prediction.predicted_temperature);
                        const confidence = Math.round(prediction.ml_confidence * 100);

                        
                        weatherAnalysis += `
                            <div style="background:#fff;padding:0.8em;margin:0.5em 0;border-radius:6px;border-left:3px solid #4CAF50;">
                                <strong>üèôÔ∏è ${city}:</strong> ${getWeatherIcon(weather)} (${temp}¬∞C) [G√ºven: %${confidence}]
                                <br><small style="color:#666;">${prediction.explanation || 'Advanced ML tabanlƒ± tahmin'}</small>
                            </div>
                        `;
                    });
                                } else {
                    // Fallback: Basit tahmin
                    for (const city of foundCities) {
                        const cityData = cityCenters[city];
                        const weather = await predictWeather(city, foundDate.month, cityData);
                        
                        weatherAnalysis += `
                            <div style="background:#fff;padding:0.8em;margin:0.5em 0;border-radius:6px;border-left:3px solid #4CAF50;">
                                <strong>üèôÔ∏è ${city}:</strong> ${weather.condition} (${weather.temp}¬∞C) [G√ºven: %${weather.confidence || 60}]
                                <br><small style="color:#666;">${weather.description}</small>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Advanced hava durumu servisi hatasƒ±:', error);
                // Fallback: Basit tahmin
                for (const city of foundCities) {
                    const cityData = cityCenters[city];
                    const weather = await predictWeather(city, foundDate.month, cityData);
                    
                    weatherAnalysis += `
                        <div style="background:#fff;padding:0.8em;margin:0.5em 0;border-radius:6px;border-left:3px solid #4CAF50;">
                            <strong>üèôÔ∏è ${city}:</strong> ${weather.condition} (${weather.temp}¬∞C) [G√ºven: %${weather.confidence || 60}]
                            <br><small style="color:#666;">${weather.description}</small>
                        </div>
                    `;
                }
            }
            
            weatherResult.innerHTML = weatherAnalysis;
        }
        
        // Advanced hava durumu tahmin fonksiyonu
        async function predictWeather(city, month, coords) {
            try {
                // Advanced hava durumu servisinden veri al
                const date = new Date();
                const year = date.getFullYear();
                const day = Math.floor(Math.random() * 28) + 1; // Rastgele g√ºn
                const dateStr = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                
                const response = await fetch('http://localhost:5001/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        city: city,
                        date: dateStr
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    return {
                        condition: getWeatherIcon(data.predicted_weather),
                        temp: Math.round(data.predicted_temperature),
                        description: data.explanation || 'Advanced ML tabanlƒ± tahmin',
                        confidence: Math.round(data.ml_confidence * 100)
                    };
                } else {
                    // Fallback: Basit mevsimsel tahmin
                    return getFallbackWeather(city, month, coords);
                }
            } catch (error) {
                console.error('Advanced hava durumu servisi hatasƒ±:', error);
                // Fallback: Basit mevsimsel tahmin
                return getFallbackWeather(city, month, coords);
            }
        }
        
        // Fallback hava durumu tahmin fonksiyonu
        function getFallbackWeather(city, month, coords) {
            let condition, temp, description;
            
            if (month >= 12 || month <= 2) {
                // Kƒ±≈ü
                if (coords[0] > 40 || coords[1] > 40) { // Doƒüu/Kuzey b√∂lgeler
                    condition = '‚ùÑÔ∏è Kar';
                    temp = Math.round(-5 + Math.random() * 10);
                    description = 'Kƒ±≈ü aylarƒ±nda kar yaƒüƒ±≈üƒ± bekleniyor';
                } else {
                    condition = 'üåßÔ∏è Yaƒümur';
                    temp = Math.round(5 + Math.random() * 10);
                    description = 'Kƒ±≈ü aylarƒ±nda yaƒümurlu hava';
                }
            } else if (month >= 6 && month <= 8) {
                // Yaz - Kesinlikle kar olmaz
                condition = '‚òÄÔ∏è G√ºne≈üli';
                temp = Math.round(25 + Math.random() * 15);
                description = 'Yaz aylarƒ±nda g√ºne≈üli ve sƒ±cak hava';
            } else if (month >= 3 && month <= 5) {
                // ƒ∞lkbahar
                if (coords[0] > 40 && Math.random() > 0.7) { // Doƒüu b√∂lgelerde bazen kar
                    condition = '‚ùÑÔ∏è Kar';
                    temp = Math.round(0 + Math.random() * 10);
                    description = 'ƒ∞lkbaharda kar yaƒüƒ±≈üƒ± bekleniyor';
                } else {
                    condition = 'üåßÔ∏è Yaƒümur';
                    temp = Math.round(10 + Math.random() * 10);
                    description = 'ƒ∞lkbaharda yaƒümurlu hava';
                }
            } else {
                // Sonbahar
                if (Math.random() > 0.6) {
                    condition = 'üåßÔ∏è Yaƒümur';
                    temp = Math.round(10 + Math.random() * 10);
                    description = 'Sonbaharda yaƒümurlu hava';
                } else {
                    condition = '‚õÖ Par√ßalƒ± Bulutlu';
                    temp = Math.round(15 + Math.random() * 10);
                    description = 'Sonbaharda deƒüi≈üken hava';
                }
            }
            
            return { condition, temp, description, confidence: 60 };
        }
        
        // Hava durumu ikonlarƒ±
        function getWeatherIcon(weather) {
            const icons = {
                'Clear': '‚òÄÔ∏è G√ºne≈üli',
                'Clouds': '‚õÖ Bulutlu',
                'Rain': 'üåßÔ∏è Yaƒümur',
                'Snow': '‚ùÑÔ∏è Kar',
                'Thunderstorm': '‚õàÔ∏è Fƒ±rtƒ±na',
                'Drizzle': 'üå¶Ô∏è √áisenti',
                'Mist': 'üå´Ô∏è Sis',
                'Fog': 'üå´Ô∏è Sis',
                'Haze': 'üå´Ô∏è Pus',
                'Smoke': 'üå´Ô∏è Duman',
                'Dust': 'üå´Ô∏è Toz',
                'Sand': 'üå´Ô∏è Kum',
                'Ash': 'üå´Ô∏è K√ºl',
                'Squall': 'üí® R√ºzgar',
                'Tornado': 'üå™Ô∏è Kasƒ±rga'
            };
            return icons[weather] || 'üå§Ô∏è Bilinmiyor';
        }
        
        // Birle≈üik rota ve hava durumu analizi butonu
        document.getElementById('route-weather-btn').addEventListener('click', async function() {
            const prompt = document.getElementById('prompt-input').value.trim();
            const promptResult = document.getElementById('prompt-result');
            const weatherResult = document.getElementById('weather-result');
            
            if (!prompt) {
                promptResult.innerHTML = '<div style="color:#f44336;">‚ùå L√ºtfen √∂nce bir prompt girin!</div>';
                return;
            }
            
            // Prompt'tan ≈üehirleri √ßƒ±kar
            promptCities = extractCitiesFromPrompt(prompt);
            console.log('Prompt\'tan √ßƒ±karƒ±lan ≈üehirler:', promptCities);
            
            // √ñnceki ≈üehir etiketlerini temizle
            clearCityLabels();
            
            // Her iki sonu√ß alanƒ±nƒ± da g√∂ster ve y√ºkleniyor mesajƒ± ver
            promptResult.innerHTML = '<div style="text-align:center;color:#666;">üöó Rota olu≈üturuluyor ve hava durumu analiz ediliyor...</div>';
            weatherResult.style.display = 'block';
            weatherResult.innerHTML = '<div style="text-align:center;color:#666;">üå§Ô∏è ML tabanlƒ± hava durumu tahmini yapƒ±lƒ±yor...</div>';
            
            try {
                // Backend'e rota ve hava durumu isteƒüi g√∂nder
                const resp = await fetch('http://localhost:5077/api/Route/plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                
                if (resp.ok) {
                    const data = await resp.json();
                    
                    // Rota sonu√ßlarƒ±nƒ± g√∂ster
                    if (data.alternatives && data.alternatives.length > 0) {
                        let routeHtml = '<div style="margin-bottom:1em;"><strong>üó∫Ô∏è Rota Se√ßenekleri:</strong></div>';
                        routeHtml += '<div id="alt-routes-list" style="display:flex;flex-direction:column;gap:1em;margin-top:1em;">';
                        
                        data.alternatives.forEach((route, index) => {
                            routeHtml += `
                                <div class="route-card" id="route-card-${index}" style="padding:1em;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);background:#fff;${index===0?'border:2px solid #2a3d66;':''}">
                                    <div style="cursor:pointer;" onclick="window.selectAltRoute(${index})">
                                        <strong>Rota ${index + 1}:</strong> ${route.distanceKm} km, ${formatDuration(route.adjustedDurationMin)}
                                        <br><small style="color:#666;">${route.summary}</small>
                                        ${route.hasToll ? '<br><span style="color:#f39c12;">üí∞ √úcretli yol</span>' : ''}
                                        ${route.weatherImpact ? `<br><span style="color:#e74c3c;font-size:0.6em;">üå§Ô∏è ${route.weatherImpact}</span>` : ''}
                                    </div>
                                    <div style="margin-top:0.5em;text-align:right;">
                                        <button onclick="window.openGoogleMaps(${index})" style="background:#4285f4;color:white;border:none;padding:0.5em 1em;border-radius:5px;cursor:pointer;font-size:0.9em;display:inline-flex;align-items:center;gap:0.3em;transition:all 0.3s ease;box-shadow:0 2px 4px rgba(66,133,244,0.3);" onmouseover="this.style.background='#3367d6';this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 8px rgba(66,133,244,0.4)'" onmouseout="this.style.background='#4285f4';this.style.transform='translateY(0)';this.style.boxShadow='0 2px 4px rgba(66,133,244,0.3)'">
                                            <span style="font-size:1.1em;">üó∫Ô∏è</span> Google Maps'te A√ß
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        routeHtml += '</div>';
                        
                        promptResult.innerHTML = routeHtml;
                        
                        // Global deƒüi≈ükenlere rotalarƒ± kaydet
                        window._promptAlternatives = data.alternatives;
                        
                        // Varsayƒ±lan olarak ilk rotayƒ± √ßiz
                        if (data.alternatives[0].polyline) {
                            showRouteOnMap(data.alternatives[0].polyline);
                        }
                        
                        // Prompt ≈üehirlerini haritada g√∂ster
                        showPromptCitiesOnMap();
                        
                        // Global prompt ≈üehirlerini kaydet
                        const promptInput = document.getElementById('prompt-input');
                        const promptText = promptInput ? promptInput.value : '';
                        console.log('Prompt text:', promptText);
                        
                        window._promptCities = extractCitiesFromPrompt(promptText);
                        console.log('Saved prompt cities:', window._promptCities);
                        
                        // Eƒüer prompt ≈üehirleri bo≈üsa, summary'den √ßƒ±kar
                        if (!window._promptCities || window._promptCities.length === 0) {
                            console.log('No prompt cities found, trying to extract from summary...');
                            if (data.alternatives && data.alternatives.length > 0) {
                                const summary = data.alternatives[0].summary || '';
                                window._promptCities = extractCitiesFromSummary(summary);
                                console.log('Extracted cities from summary:', window._promptCities);
                            }
                        }
                        
                        // Rota se√ßme fonksiyonlarƒ±nƒ± tanƒ±mla
                        window.selectAltRoute = function(idx) {
                            // √ñnceki se√ßili rotayƒ± temizle
                            document.querySelectorAll('.route-card').forEach(card => {
                                card.style.border = '1px solid #ddd';
                            });
                            // Se√ßili rotayƒ± vurgula
                            document.getElementById(`route-card-${idx}`).style.border = '2px solid #2a3d66';
                            
                            // Haritada rotayƒ± g√∂ster
                            const alt = window._promptAlternatives[idx];
                            if (alt.polyline) {
                                showRouteOnMap(alt.polyline);
                            }
                        };
                        
                        // Google Maps'te rota a√ßma fonksiyonu
                        window.openGoogleMaps = function(idx) {
                            const route = window._promptAlternatives[idx];
                            console.log('Opening Google Maps for route:', route);
                            console.log('Route details:', {
                                polyline: route.polyline ? route.polyline.substring(0, 50) + '...' : 'No polyline',
                                polylineLength: route.polyline ? route.polyline.length : 0,
                                steps: route.steps ? route.steps.length + ' steps' : 'No steps',
                                summary: route.summary,
                                route: route.route,
                                hasPolyline: !!route.polyline,
                                hasSteps: !!route.steps
                            });
                            
                            // Prompt ≈üehirlerini kontrol et
                            console.log('Prompt cities check:', {
                                hasPromptCities: !!window._promptCities,
                                promptCities: window._promptCities,
                                promptCitiesLength: window._promptCities ? window._promptCities.length : 0
                            });
                            
                            if (!route) {
                                console.error('Route not found');
                                return;
                            }
                            
                                                                            // 1. Google Maps sƒ±ralƒ± rota (en g√ºvenilir y√∂ntem - √∂ncelik)
                        if (window._promptCities && window._promptCities.length >= 2) {
                            console.log('Using prompt cities for Google Maps:', window._promptCities);
                            
                            // T√ºm ≈üehirleri sƒ±rayla ziyaret etmek i√ßin
                            if (window._promptCities.length === 2) {
                                // Sadece 2 ≈üehir varsa
                                const googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(window._promptCities[0])}/${encodeURIComponent(window._promptCities[1])}`;
                                console.log('Opening Google Maps with 2 cities:', googleMapsUrl);
                                window.open(googleMapsUrl, '_blank');
                                return;
                            } else if (window._promptCities.length === 3) {
                                // 3 ≈üehir varsa: A -> B -> C (sƒ±rayla)
                                const googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(window._promptCities[0])}/${encodeURIComponent(window._promptCities[1])}/${encodeURIComponent(window._promptCities[2])}`;
                                console.log('Opening Google Maps with 3 cities in order:', googleMapsUrl);
                                window.open(googleMapsUrl, '_blank');
                                return;
                            } else if (window._promptCities.length === 4) {
                                // 4 ≈üehir varsa: A -> B -> C -> D (sƒ±rayla)
                                const googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(window._promptCities[0])}/${encodeURIComponent(window._promptCities[1])}/${encodeURIComponent(window._promptCities[2])}/${encodeURIComponent(window._promptCities[3])}`;
                                console.log('Opening Google Maps with 4 cities in order:', googleMapsUrl);
                                window.open(googleMapsUrl, '_blank');
                                return;
                            } else {
                                // 4'ten fazla ≈üehir varsa sƒ±rayla ekle
                                const citiesStr = window._promptCities.map(city => encodeURIComponent(city)).join('/');
                                const googleMapsUrl = `https://www.google.com/maps/dir/${citiesStr}`;
                                console.log('Opening Google Maps with multiple cities in order:', googleMapsUrl);
                                window.open(googleMapsUrl, '_blank');
                                return;
                            }
                        }
                        
                        // 2. Polyline'dan detaylƒ± rota olu≈ütur (alternatif y√∂ntem)
                        if (route.polyline && route.polyline.length > 0) {
                            try {
                                const coordinates = decodePolyline(route.polyline);
                                console.log('Decoded polyline coordinates:', coordinates.length, 'points');
                                
                                if (coordinates.length >= 2) {
                                    // Koordinatlarƒ± kontrol et
                                    const validCoordinates = coordinates.filter(point => 
                                        point && typeof point.lat === 'number' && typeof point.lng === 'number' &&
                                        !isNaN(point.lat) && !isNaN(point.lng) &&
                                        point.lat >= -90 && point.lat <= 90 &&
                                        point.lng >= -180 && point.lng <= 180
                                    );
                                    
                                    if (validCoordinates.length < 2) {
                                        console.error('Not enough valid coordinates:', validCoordinates.length);
                                        throw new Error('Invalid coordinates');
                                    }
                                    
                                    // Karma≈üƒ±k rotalar i√ßin √∂nemli noktalarƒ± se√ß
                                    const startPoint = validCoordinates[0];
                                    const endPoint = validCoordinates[validCoordinates.length - 1];
                                    
                                    console.log('Start point:', startPoint);
                                    console.log('End point:', endPoint);
                                    
                                    // Rota uzunluƒüuna g√∂re strateji belirle
                                    if (validCoordinates.length > 100) {
                                        // √áok uzun rota - √∂nemli d√∂n√º≈ü noktalarƒ±nƒ± se√ß
                                        const step = Math.floor(validCoordinates.length / 10); // 10 √∂nemli nokta
                                        const importantPoints = [];
                                        
                                        for (let i = 0; i < validCoordinates.length; i += step) {
                                            if (importantPoints.length < 10) {
                                                importantPoints.push(validCoordinates[i]);
                                            }
                                        }
                                        
                                        // Son noktayƒ± ekle
                                        if (importantPoints[importantPoints.length - 1] !== endPoint) {
                                            importantPoints.push(endPoint);
                                        }
                                        
                                        // Google Maps URL'si olu≈ütur
                                        const pointsStr = importantPoints.map(point => 
                                            `${point.lat.toFixed(6)},${point.lng.toFixed(6)}`
                                        ).join('/');
                                        
                                        const googleMapsUrl = `https://www.google.com/maps/dir/${pointsStr}`;
                                        console.log('Opening Google Maps with complex route:', googleMapsUrl);
                                        window.open(googleMapsUrl, '_blank');
                                        return;
                                    } else {
                                        // Kƒ±sa rota - t√ºm noktalarƒ± kullan
                                        const pointsStr = validCoordinates.map(point => 
                                            `${point.lat.toFixed(6)},${point.lng.toFixed(6)}`
                                        ).join('/');
                                        
                                        const googleMapsUrl = `https://www.google.com/maps/dir/${pointsStr}`;
                                        console.log('Opening Google Maps with full route:', googleMapsUrl);
                                        window.open(googleMapsUrl, '_blank');
                                        return;
                                    }
                                } else {
                                    console.error('Not enough coordinates:', coordinates.length);
                                }
                            } catch (error) {
                                console.error('Polyline decode error:', error);
                            }
                        }
                        
                        // 2. Route steps'lerini kullan (alternatif y√∂ntem)
                        if (route.steps && route.steps.length > 0) {
                            console.log('Using route steps for Google Maps:', route.steps);
                            
                            // Steps'lerden √∂nemli noktalarƒ± √ßƒ±kar
                            const importantSteps = route.steps.filter(step => 
                                step.instruction && 
                                (step.instruction.includes('saƒüa') || 
                                 step.instruction.includes('sola') || 
                                 step.instruction.includes('d√ºz') ||
                                 step.instruction.includes('d√∂n') ||
                                 step.instruction.includes('√ßƒ±k'))
                            );
                            
                            // Global prompt ≈üehirlerini kullan ve steps'leri waypoint olarak ekle
                            if (window._promptCities && window._promptCities.length >= 2) {
                                const startCity = window._promptCities[0];
                                const endCity = window._promptCities[window._promptCities.length - 1];
                                
                                let googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(startCity)}/${encodeURIComponent(endCity)}`;
                                
                                // √ñnemli steps'leri waypoint olarak ekle
                                if (importantSteps.length > 0) {
                                    const maxSteps = Math.min(importantSteps.length, 10); // Maksimum 10 √∂nemli adƒ±m
                                    const selectedSteps = importantSteps.slice(0, maxSteps);
                                    const stepsStr = selectedSteps.map(step => 
                                        encodeURIComponent(step.instruction.split(' ').slice(0, 3).join(' '))
                                    ).join('/');
                                    googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(startCity)}/${stepsStr}/${encodeURIComponent(endCity)}`;
                                }
                                
                                console.log('Opening Google Maps with steps:', googleMapsUrl);
                                window.open(googleMapsUrl, '_blank');
                                return;
                            }
                        }
                        
                        // 2. Polyline'dan tam rotayƒ± olu≈ütur (alternatif y√∂ntem)
                        if (route.polyline && route.polyline.length > 0) {
                            try {
                                const coordinates = decodePolyline(route.polyline);
                                console.log('Decoded coordinates:', coordinates);
                                
                                if (coordinates.length >= 2) {
                                    // Google Maps URL'si i√ßin waypoint'leri hazƒ±rla
                                    const waypoints = coordinates.slice(1, -1); // ƒ∞lk ve son nokta hari√ß
                                    const startPoint = coordinates[0];
                                    const endPoint = coordinates[coordinates.length - 1];
                                    
                                    // Koordinatlarƒ± doƒüru formatta kontrol et ve formatla
                                    if (typeof startPoint.lat === 'number' && typeof startPoint.lng === 'number' &&
                                        typeof endPoint.lat === 'number' && typeof endPoint.lng === 'number') {
                                        
                                        // Koordinatlarƒ± string olarak formatla
                                        const startLat = startPoint.lat.toFixed(6);
                                        const startLng = startPoint.lng.toFixed(6);
                                        const endLat = endPoint.lat.toFixed(6);
                                        const endLng = endPoint.lng.toFixed(6);
                                        
                                        let googleMapsUrl = `https://www.google.com/maps/dir/${startLat},${startLng}/${endLat},${endLng}`;
                                        
                                        // Waypoint'leri ekle (Google Maps maksimum 23 waypoint destekler)
                                        if (waypoints.length > 0) {
                                            const maxWaypoints = Math.min(waypoints.length, 23);
                                            const selectedWaypoints = waypoints.slice(0, maxWaypoints);
                                            
                                            // Waypoint koordinatlarƒ±nƒ± kontrol et ve formatla
                                            const validWaypoints = selectedWaypoints.filter(wp => 
                                                typeof wp.lat === 'number' && typeof wp.lng === 'number' &&
                                                !isNaN(wp.lat) && !isNaN(wp.lng)
                                            );
                                            
                                            if (validWaypoints.length > 0) {
                                                const waypointsStr = validWaypoints.map(wp => 
                                                    `${wp.lat.toFixed(6)},${wp.lng.toFixed(6)}`
                                                ).join('/');
                                                googleMapsUrl = `https://www.google.com/maps/dir/${startLat},${startLng}/${waypointsStr}/${endLat},${endLng}`;
                                            }
                                        }
                                        
                                        console.log('Opening Google Maps with full route:', googleMapsUrl);
                                        window.open(googleMapsUrl, '_blank');
                                        return;
                                    } else {
                                        console.error('Invalid coordinate format:', startPoint, endPoint);
                                    }
                                }
                            } catch (error) {
                                console.error('Polyline decode error:', error);
                            }
                        }
                            
                            
                            
                            // 3. Route verilerinden ba≈ülangƒ±√ß ve biti≈ü noktalarƒ±nƒ± al
                            if (route.route && route.route.length >= 2) {
                                const startPoint = route.route[0];
                                const endPoint = route.route[route.route.length - 1];
                                const googleMapsUrl = `https://www.google.com/maps/dir/${startPoint.lat},${startPoint.lng}/${endPoint.lat},${endPoint.lng}`;
                                console.log('Opening Google Maps with route coordinates:', startPoint, endPoint);
                                window.open(googleMapsUrl, '_blank');
                                return;
                            }
                            
                            // 4. Alternatif olarak ≈üehir isimlerini kullan
                            if (route.summary) {
                                const cities = extractCitiesFromSummary(route.summary);
                                if (cities.length >= 2) {
                                    const googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(cities[0])}/${encodeURIComponent(cities[1])}`;
                                    console.log('Opening Google Maps with cities:', cities);
                                    window.open(googleMapsUrl, '_blank');
                                    return;
                                }
                            }
                            
                            console.error('No valid coordinates found for route');
                            alert('Bu rota i√ßin Google Maps a√ßƒ±lamƒ±yor. L√ºtfen farklƒ± bir rota deneyin.');
                        };
                        
                        // Summary'den ≈üehir isimlerini √ßƒ±kar
                        function extractCitiesFromSummary(summary) {
                            const cityNames = [
                                'ƒ∞stanbul', 'Ankara', 'ƒ∞zmir', 'Bursa', 'Antalya', 'Adana', 'Konya', 'Gaziantep',
                                'Mersin', 'Diyarbakƒ±r', 'Samsun', 'Denizli', 'Eski≈üehir', 'Urfa', 'Malatya',
                                'Erzurum', 'Van', 'Batman', 'Elazƒ±ƒü', 'ƒ∞√ßel', 'Kocaeli', 'Manisa', 'Kayseri',
                                'Sivas', 'Balƒ±kesir', 'Kahramanmara≈ü', 'Tekirdaƒü', 'Sakarya', 'Aydƒ±n', 'Muƒüla'
                            ];
                            
                            const foundCities = [];
                            for (const city of cityNames) {
                                if (summary.toLowerCase().includes(city.toLowerCase())) {
                                    foundCities.push(city);
                                }
                            }
                            return foundCities;
                        }
                        
                        // Polyline decode fonksiyonu
                        function decodePolyline(encoded) {
                            if (!encoded || typeof encoded !== 'string' || encoded.length === 0) {
                                console.error('Invalid polyline data:', encoded);
                                return [];
                            }
                            
                            const poly = [];
                            let index = 0, len = encoded.length;
                            let lat = 0, lng = 0;
                            
                            try {
                                while (index < len) {
                                    let shift = 0, result = 0;
                                    
                                    do {
                                        if (index >= len) {
                                            console.error('Unexpected end of polyline data');
                                            return poly;
                                        }
                                        let b = encoded.charCodeAt(index++) - 63;
                                        result |= (b & 0x1f) << shift;
                                        shift += 5;
                                    } while (result >= 0x20);
                                    
                                    let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                                    lat += dlat;
                                    
                                    shift = 0;
                                    result = 0;
                                    
                                    do {
                                        if (index >= len) {
                                            console.error('Unexpected end of polyline data');
                                            return poly;
                                        }
                                        let b = encoded.charCodeAt(index++) - 63;
                                        result |= (b & 0x1f) << shift;
                                        shift += 5;
                                    } while (result >= 0x20);
                                    
                                    let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                                    lng += dlng;
                                    
                                    // Koordinatlarƒ± doƒüru formatta kaydet ve kontrol et
                                    const latCoord = parseFloat((lat / 1E5).toFixed(6));
                                    const lngCoord = parseFloat((lng / 1E5).toFixed(6));
                                    
                                    if (!isNaN(latCoord) && !isNaN(lngCoord) && 
                                        latCoord >= -90 && latCoord <= 90 && 
                                        lngCoord >= -180 && lngCoord <= 180) {
                                        poly.push({
                                            lat: latCoord,
                                            lng: lngCoord
                                        });
                                    } else {
                                        console.error('Invalid coordinates:', latCoord, lngCoord);
                                    }
                                }
                                
                                console.log('Successfully decoded polyline:', poly.length, 'coordinates');
                                return poly;
                            } catch (error) {
                                console.error('Polyline decode error:', error);
                                return [];
                            }
                        }
                        

                        
                    } else {
                        promptResult.innerHTML = '<div style="color:#f44336;">‚ùå Rota bulunamadƒ±!</div>';
                    }
                    
                    // ML hava durumu tahminlerini g√∂ster
                    if (data.weatherPredictions && data.weatherPredictions.length > 0) {
                        let weatherHtml = '<div style="margin-bottom:1em;"><strong>üå§Ô∏è ML Tabanlƒ± Hava Durumu Tahminleri:</strong></div>';
                        
                        data.weatherPredictions.forEach(pred => {
                            // Hava durumu emoji'si
                            let weatherEmoji = 'üå§Ô∏è';
                            if (pred.predictedWeather.includes('kar')) weatherEmoji = '‚ùÑÔ∏è';
                            else if (pred.predictedWeather.includes('yaƒümur')) weatherEmoji = 'üåßÔ∏è';
                            else if (pred.predictedWeather.includes('g√ºne≈ü')) weatherEmoji = '‚òÄÔ∏è';
                            else if (pred.predictedWeather.includes('bulut')) weatherEmoji = '‚õÖ';
                            
                            weatherHtml += `
                                <div style="background:#fff;padding:1em;margin:0.5em 0;border-radius:8px;border-left:4px solid #4CAF50;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.5em;">
                                        <span style="font-size:1.5em;">${weatherEmoji}</span>
                                        <strong style="font-size:1.1em;">üèôÔ∏è ${pred.city}</strong>
                                    </div>
                                    <div style="margin-bottom:0.5em;">
                                        <strong>Beklenen Hava ≈ûartƒ±:</strong> ${pred.predictedWeather}
                                        <br><strong>Sƒ±caklƒ±k:</strong> ${pred.avgTemperature}¬∞C
                                        <br><strong>ƒ∞klim B√∂lgesi:</strong> ${pred.climateZone}
                                    </div>
                                    <div style="background:#f8f9fa;padding:0.5em;border-radius:4px;margin-bottom:0.5em;font-size:0.9em;color:#555;">
                                        <strong>üìä Tahmin Detayƒ±:</strong><br>${pred.explanation}
                                    </div>
                                    ${pred.trafficExplanation ? `<div style="background:#fff3cd;padding:0.5em;border-radius:4px;margin-bottom:0.5em;font-size:0.9em;color:#856404;"><strong>üöó Trafik:</strong> ${pred.trafficExplanation}</div>` : ''}
                                    <div style="text-align:right;font-size:0.9em;color:#666;">
                                        <strong>G√ºven Oranƒ±:</strong> %${Math.round(pred.confidence * 100)}
                                    </div>
                                </div>
                            `;
                        });
                        
                        weatherResult.innerHTML = weatherHtml;
                    } else {
                        weatherResult.innerHTML = '<div style="color:#f44336;">‚ùå Hava durumu tahmini yapƒ±lamadƒ±!</div>';
                    }
                    
                    // Rota √∂zeti
                    if (data.routeSummary) {
                        let summaryHtml = '<div style="margin-top:1em;padding:1em;background:#e8f5e8;border-radius:8px;border-left:4px solid #4CAF50;"><strong>üìä Rota √ñzeti:</strong><br>';
                        summaryHtml += `Toplam ${data.routeSummary.totalCities} ≈üehir<br>`;
                        if (data.routeSummary.isHolidayPeriod) {
                            summaryHtml += `üéâ ${data.routeSummary.holidayName} d√∂nemi<br>`;
                        }
                        summaryHtml += `Ortalama trafik √ßarpanƒ±: ${data.routeSummary.avgTrafficMultiplier.toFixed(2)}x<br>`;
                        summaryHtml += `Toplam s√ºre etkisi: ${data.routeSummary.totalDurationImpact.toFixed(2)}x</div>`;
                        
                        weatherResult.innerHTML += summaryHtml;
                    }
                    
                } else {
                    const errorData = await resp.json();
                    if (errorData.error && errorData.error.includes("Sizi anlayamadƒ±m")) {
                        promptResult.innerHTML = `<div style="color:#f44336;font-size:1.2em;font-weight:bold;">‚ùå ${errorData.error}</div>`;
                        if (errorData.suggestion) {
                            promptResult.innerHTML += `<div style="color:#666;margin-top:0.5em;font-size:1em;">üí° ${errorData.suggestion}</div>`;
                        }
                    } else {
                        promptResult.innerHTML = '<div style="color:#f44336;">‚ùå Sunucuya ula≈üƒ±lamadƒ± veya hata olu≈ütu.</div>';
                    }
                    weatherResult.innerHTML = '<div style="color:#f44336;">‚ùå Hava durumu analizi yapƒ±lamadƒ±!</div>';
                }
                
            } catch (error) {
                console.error('Hata:', error);
                if (error.message && error.message.includes("Sizi anlayamadƒ±m")) {
                    promptResult.innerHTML = `<div style="color:#f44336;font-size:1.2em;font-weight:bold;">‚ùå ${error.message}</div>`;
                } else {
                    promptResult.innerHTML = '<div style="color:#f44336;">‚ùå Sunucuya ula≈üƒ±lamadƒ± veya hata olu≈ütu.</div>';
                }
                weatherResult.innerHTML = '<div style="color:#f44336;">‚ùå Hava durumu analizi yapƒ±lamadƒ±!</div>';
            }
        });
        
        // Prompt'tan ≈üehirleri √ßƒ±kar
        function extractCitiesFromPrompt(prompt) {
            const cities = [];
            const promptLower = prompt.toLowerCase();
            
            // ≈ûehirleri prompt'taki sƒ±raya g√∂re bul
            for (const cityName in cityCenters) {
                const cityNameLower = cityName.toLowerCase();
                const position = promptLower.indexOf(cityNameLower);
                if (position >= 0) {
                    cities.push({ name: cityName, position: position });
                }
            }
            
            // ≈ûehirleri prompt'taki pozisyonlarƒ±na g√∂re sƒ±rala
            cities.sort((a, b) => a.position - b.position);
            
            // Sadece ≈üehir isimlerini d√∂nd√ºr
            return cities.map(city => city.name);
        }
        
        // Prompt'tan tarihi √ßƒ±kar
        function extractDateFromPrompt(prompt) {
            const monthMap = {
                'ocak': 1, 'january': 1, '≈üubat': 2, 'february': 2, 'mart': 3, 'march': 3,
                'nisan': 4, 'april': 4, 'mayƒ±s': 5, 'may': 5, 'haziran': 6, 'june': 6,
                'temmuz': 7, 'july': 7, 'aƒüustos': 8, 'august': 8, 'eyl√ºl': 9, 'september': 9,
                'ekim': 10, 'october': 10, 'kasƒ±m': 11, 'november': 11, 'aralƒ±k': 12, 'december': 12
            };
            
            // DD.MM.YYYY formatƒ±nƒ± kontrol et (12.02.2026)
            const dotDatePattern = /(\d{1,2})\.(\d{1,2})\.(\d{4})/;
            const dotDateMatch = prompt.match(dotDatePattern);
            if (dotDateMatch) {
                const day = dotDateMatch[1].padStart(2, '0');
                const month = dotDateMatch[2].padStart(2, '0');
                const year = dotDateMatch[3];
                return `${year}-${month}-${day}`;
            }
            
            // Ay isimlerini kontrol et
            for (const monthName in monthMap) {
                if (prompt.toLowerCase().includes(monthName)) {
                    return `${new Date().getFullYear()}-${monthMap[monthName].toString().padStart(2, '0')}-01`;
                }
            }
            return new Date().toISOString().split('T')[0];
        }
    </script>
</body>
</html> 